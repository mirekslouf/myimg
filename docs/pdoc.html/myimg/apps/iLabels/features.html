<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.3"/>
    <title>myimg.apps.iLabels.features API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../iLabels.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;myimg.apps.iLabels</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#get_features">get_features</a>
            </li>
            <li>
                    <a class="function" href="#extended_features">extended_features</a>
            </li>
            <li>
                    <a class="function" href="#roi_features">roi_features</a>
            </li>
            <li>
                    <a class="function" href="#corr_features">corr_features</a>
            </li>
            <li>
                    <a class="function" href="#gauss_features">gauss_features</a>
            </li>
            <li>
                    <a class="function" href="#gauss_params">gauss_params</a>
            </li>
            <li>
                    <a class="function" href="#gauss2D">gauss2D</a>
            </li>
            <li>
                    <a class="function" href="#visualize_features">visualize_features</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../../myimg.html">myimg</a><wbr>.<a href="./../../apps.html">apps</a><wbr>.<a href="./../iLabels.html">iLabels</a><wbr>.features    </h1>

                        <div class="docstring"><p>Created on Tue Apr 29 08:08:54 2025</p>

<p>@author: p-sik</p>
</div>

                        <input id="mod-features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-features-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">Created on Tue Apr 29 08:08:54 2025</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">@author: p-sik</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">import</span> <span class="nn">scipy.stats</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">label</span><span class="p">,</span> <span class="n">regionprops</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="kn">import</span> <span class="n">threshold_otsu</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">opening</span><span class="p">,</span> <span class="n">disk</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="kn">import</span> <span class="n">match_template</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="k">def</span> <span class="nf">get_features</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">    Extracts and combines multiple types of features from ROI images:</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">        - statistical</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">        - morphological</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">        - correlation-based</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">        - Gaussian-fitting features.</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">    Parameters:</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">    -----------</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">    rois : list of tuple</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">        List of tuples where each tuple is (roi, label), with:</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">        - roi : np.ndarray</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">            A 2D array representing the image of the ROI.</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">        - label : str or int</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">            Identifier or class label for the ROI.</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">        DataFrame containing metadata for each ROI. It is expected to contain</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">        information like coordinates, class labels, and notes.</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">    masks : list of np.ndarray</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">        List of binary masks (same size as ROIs), where each mask defines the </span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        region of interest used for correlation feature extraction.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">    show : bool, optional </span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">        If True, displays visualizations during feature extraction (e.g., for </span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        verification). Default is False.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    Returns:</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    --------</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    combined_props : pandas.DataFrame</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">        A DataFrame containing all extracted features:</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">        - Statistical and morphological features</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">        - Gaussian fit parameters</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">        - Correlation-based features</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">        The class column is retained only once to avoid duplication.</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">    propsArr : np.ndarray</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">        A NumPy array containing additional features or summary statistics, </span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">        typically used for low-dimensional numerical representation.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">    Notes:</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">    ------</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">    - Internally calls:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">        - `extended_features()` for statistical and morphological features</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">        - `corr_features()` for correlation metrics using masks</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">        - `gauss_params()` and `gauss_features()` for Gaussian fitting</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    <span class="c1"># Access the first element (the ROI image) of each tuple</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="n">rois_only</span> <span class="o">=</span> <span class="p">[</span><span class="n">roi_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">roi_data</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">]</span>  
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>    
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>    <span class="c1"># Compute statistical and morphological features </span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>    <span class="n">propsFloat</span><span class="p">,</span> <span class="n">propsArr</span> <span class="o">=</span> <span class="n">extended_features</span><span class="p">(</span><span class="n">rois_only</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">show</span><span class="p">)</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>    
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>    <span class="c1"># Compute correlation features</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>    <span class="n">propsCorr</span> <span class="o">=</span> <span class="n">corr_features</span><span class="p">(</span><span class="n">rois_only</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">masks</span><span class="p">)</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>    
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="c1"># Compute gaussian features</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>    <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss_params</span><span class="p">(</span><span class="n">rois_only</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>    <span class="n">propsGauss</span> <span class="o">=</span> <span class="n">gauss_features</span><span class="p">(</span><span class="n">gauss</span><span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>    <span class="c1"># Remove &#39;class&#39; column from one of the dataframes (propsGauss or propsFloat)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="n">propsGauss</span> <span class="o">=</span> <span class="n">propsGauss</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>    
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>    <span class="c1"># Concatenate the two dataframes along axis 1 (columns)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>    <span class="n">combined_props</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">propsFloat</span><span class="p">,</span> <span class="n">propsGauss</span><span class="p">,</span> <span class="n">propsCorr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>    <span class="k">return</span> <span class="n">combined_props</span><span class="p">,</span> <span class="n">propsArr</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="k">def</span> <span class="nf">extended_features</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">    Extracts and extends feature sets from a list of Region of Interest (ROI)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">    images and returns two DataFrames containing scalar and array-based features </span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">    respectively.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">    The function computes basic ROI features via `roi_features()` and then </span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">    performs additional morphological and shape analysis on each ROI, including </span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">    thresholding (Otsu), morphological filtering, region labeling, and extraction </span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">    of geometric and moment-based properties. </span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">    Parameters</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">    ----------</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">    rois : list of ndarray</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">        List of 2D NumPy arrays, each representing an ROI (grayscale image).</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">    </span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">        DataFrame containing metadata associated with each ROI, including a </span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        &#39;Class&#39; column that specifies the particle category or label.</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">    </span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">    show : bool, optional (default=True)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">        If True, displays boxplots of each numeric feature grouped by class. </span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">        Skips features that are non-numeric or contain NaN/inf.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">    Returns</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">    -------</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">    df1 : pandas.DataFrame</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">        DataFrame with original `df` columns, features from `roi_features`, </span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="sd">        and additional scalar morphological features such as area, eccentricity, </span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">        solidity, etc.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">    </span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">    df2 : pandas.DataFrame</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">        DataFrame with original `df` columns and array-based features including </span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">        image moments and central moments for each ROI.</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">    </span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">    Notes</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">    -----</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">    - For ROIs that are empty or contain uniform values, NaNs are assigned to </span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">      all extracted features.</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">    - Features extracted include:</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">        - Scalar: area, convex area, eccentricity, solidity, equivalent diameter, </span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">                  extent, number of pixels, orientation, and perimeter.</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">        - Array: raw spatial moments and central moments (both as 3x3 arrays).</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">    - The function assumes that the `df` DataFrame has the same number of rows </span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">      as the number of ROIs provided, and that it includes a &#39;Class&#39; column for </span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">      grouping.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">    </span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">    Raises</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">    ------</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">    Handles all exceptions during individual ROI processing and prints an error </span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">    message.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>    <span class="n">binary</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    <span class="n">labeled</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>    
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>    <span class="c1"># This will hold dictionaries for each ROI with selected properties</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>    <span class="n">props_float</span> <span class="o">=</span> <span class="p">[]</span>  
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>    <span class="n">props_arr</span> <span class="o">=</span> <span class="p">[]</span>  
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>    <span class="n">roi_df</span> <span class="o">=</span> <span class="n">roi_features</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>    
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rois</span><span class="p">):</span>        <span class="c1"># Skip or handle empty arrays</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="n">binary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>            <span class="n">labeled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>            <span class="n">roi_properties1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>                                <span class="s1">&#39;area_convex&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>                                <span class="s1">&#39;eccentricity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>                                <span class="s1">&#39;solidity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>                                <span class="s1">&#39;equivalent_diameter_area&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>                                <span class="s1">&#39;extent&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>                                <span class="s1">&#39;num_pixels&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>                                <span class="s1">&#39;orientation&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>                                <span class="s1">&#39;perimeter&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>                                <span class="s1">&#39;otsu&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>                                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>                                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>                                    <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>                                <span class="p">}</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>            
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>            <span class="n">roi_properties2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;moments&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>                              <span class="s1">&#39;moments_central&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>                              <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>                                        <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="p">],</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>                              <span class="p">}</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>            <span class="n">props_float</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties1</span><span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="n">props_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties2</span><span class="p">)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="k">continue</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>        <span class="c1"># Replace NaNs with 0 (or another strategy)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>        <span class="n">roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="c1"># Skip if all values are the same (e.g., all 0)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">roi</span> <span class="o">==</span> <span class="n">roi</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>            <span class="n">binary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>            <span class="n">labeled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="n">roi_properties1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                                <span class="s1">&#39;area_convex&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>                                <span class="s1">&#39;eccentricity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>                                <span class="s1">&#39;solidity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>                                <span class="s1">&#39;equivalent_diameter_area&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>                                <span class="s1">&#39;extent&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>                                <span class="s1">&#39;num_pixels&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>                                <span class="s1">&#39;orientation&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>                                <span class="s1">&#39;perimeter&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>                                <span class="s1">&#39;otsu&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>                                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>                                    <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>                                <span class="p">}</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>            
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>            <span class="n">roi_properties2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;moments&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>                              <span class="s1">&#39;moments_central&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>                              <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>                                  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>                                  <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>                              <span class="p">}</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>                
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>            <span class="n">props_float</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties1</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>            <span class="n">props_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties2</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>            <span class="k">continue</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>            <span class="c1"># Get threshold using Otsu method</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="c1"># TODO zamyslet se, jestli by nebylo lepsi pouzivat 1 globalni </span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="c1"># threshold pro vsechny nanocastice</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>            <span class="n">thresh</span> <span class="o">=</span> <span class="n">threshold_otsu</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="n">binim</span> <span class="o">=</span> <span class="n">roi</span> <span class="o">&gt;</span> <span class="n">thresh</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            <span class="c1"># Apply morphological opening to remove small noise</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>            <span class="n">binim_filtered</span> <span class="o">=</span> <span class="n">opening</span><span class="p">(</span><span class="n">binim</span><span class="p">,</span> <span class="n">disk</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>            <span class="n">binary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binim_filtered</span><span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>            <span class="c1"># Label the filtered binary image</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>            <span class="n">lab</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">binim_filtered</span><span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>            <span class="n">labeled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span> 
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>            <span class="c1"># Calculate region properties</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="n">regions</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>            
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="c1"># Initialize a dictionary to store selected properties for this ROI</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="n">roi_properties1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                                <span class="s1">&#39;area_convex&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>                                <span class="s1">&#39;eccentricity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>                                <span class="s1">&#39;solidity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>                                <span class="s1">&#39;equivalent_diameter_area&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>                                <span class="s1">&#39;extent&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                                <span class="s1">&#39;num_pixels&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>                                <span class="s1">&#39;orientation&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>                                <span class="s1">&#39;perimeter&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>                                <span class="s1">&#39;otsu&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>                                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>                                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>                                    <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                                <span class="p">}</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>            
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>            <span class="n">roi_properties2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;moments&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>                              <span class="s1">&#39;moments_central&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>                              <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>                                  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                                  <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                              <span class="p">}</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>            <span class="k">if</span> <span class="n">regions</span><span class="p">:</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>                <span class="n">region</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>                
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                <span class="c1"># Add properties you want to track</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                <span class="c1"># (1) AREA OF THE REGION (number of pixels of the region </span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                <span class="c1"># scaled by pixel-area)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">area</span> 
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>                <span class="c1"># (2) AREA OF THE CONVEX HULL IMAGE (the smallest convex polygon </span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                <span class="c1"># that encloses the region)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;area_convex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">area_convex</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>                
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>                <span class="c1"># (3) ECCENTRICITY (the ratio of the focal distance (distance </span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                <span class="c1"># between focal points) over the major axis length. The value </span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                <span class="c1"># is in the interval [0, 1). When it is 0, the ellipse becomes </span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                <span class="c1"># a circle.</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;eccentricity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">eccentricity</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>                
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                <span class="c1"># (4) SOLIDITY (Ratio of pixels in the region to pixels of the </span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                <span class="c1"># convex hull image.)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;solidity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">solidity</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>                
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>                <span class="c1"># (5) EQUIVALENT DIAMETER AREA (the diameter of a circle with </span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>                <span class="c1"># the same area as the region)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;equivalent_diameter_area&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                    <span class="n">region</span><span class="o">.</span><span class="n">equivalent_diameter_area</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>                
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>                <span class="c1"># (6) EXTENT (ratio of pixels in the region to pixels in the </span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                <span class="c1"># total bounding box. Computed as area / (rows * cols))</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;extent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">extent</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                <span class="c1"># (7) NUMBER OF PIXELS (number of foreground pixels)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;num_pixels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">num_pixels</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>                <span class="c1"># (8) ORIENTATION (angle between the 0th axis (rows) and the </span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>                <span class="c1"># major axis of the ellipse that has the same second moments </span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>                <span class="c1"># as the region, ranging from -pi/2 to pi/2 counter-clockwise.)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">orientation</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>                
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                <span class="c1"># (9) PERIMETER (Perimeter of object which approximates the </span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>                <span class="c1"># contour as a line through the centers of border pixels using </span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>                <span class="c1"># a 4-connectivity.)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;perimeter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">perimeter</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>                
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                <span class="c1"># (10) OTSU THRESHOLD</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;otsu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>                
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                <span class="c1"># (10) MOMENTS (spatial moments up to 3rd order, 3x3 array)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                <span class="n">roi_properties2</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">moments</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>                
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                <span class="c1"># (11) MOMENTS CENTRAL (central moments (translation invariant) </span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>                <span class="c1"># up to 3rd order, 3x3 array)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>                <span class="n">roi_properties2</span><span class="p">[</span><span class="s1">&#39;moments_central&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">moments_central</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>                
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>            
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            <span class="c1"># Append the properties dictionary for this ROI</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="c1"># FLOAT properties</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>            <span class="n">props_float</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties1</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>            
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>            <span class="c1"># ARRAY properties</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="n">props_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties2</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="c1"># Catch unexpected errors and handle them gracefully</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="n">binary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="n">labeled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="c1"># FLOAT properties</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            <span class="n">props_float</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                                    <span class="s1">&#39;area_convex&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>                                    <span class="s1">&#39;eccentricity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                                    <span class="s1">&#39;solidity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                                    <span class="s1">&#39;equivalent_diameter_area&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                                    <span class="s1">&#39;extent&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                                    <span class="s1">&#39;num_pixels&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                                    <span class="s1">&#39;orientation&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                                    <span class="s1">&#39;perimeter&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                                    <span class="s1">&#39;otsu&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                                    <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>                                        <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                                    <span class="p">})</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>            
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>            <span class="c1"># ARRAY properties</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>            <span class="n">props_arr</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;moments&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>                              <span class="s1">&#39;moments_central&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                              <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>                                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>                                    <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>                                <span class="p">})</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>            
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>            
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping ROI due to error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>    
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>    <span class="c1"># Convert the list of dictionaries to a pandas DataFrame</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>    <span class="n">properties_df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">props_float</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>    <span class="n">properties_df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">props_arr</span><span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>    <span class="c1"># If any rows have missing data (None), fill those rows with NaN</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>    <span class="n">properties_df1</span> <span class="o">=</span> <span class="n">properties_df1</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>    <span class="n">properties_df2</span> <span class="o">=</span> <span class="n">properties_df2</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                 
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>    
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>    <span class="c1"># Drop duplicate &#39;class&#39; column to avoid conflicts</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>    <span class="n">roi_df</span> <span class="o">=</span> <span class="n">roi_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>    <span class="n">properties_df1</span> <span class="o">=</span> <span class="n">properties_df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>    <span class="n">properties_df2</span> <span class="o">=</span> <span class="n">properties_df2</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>    <span class="c1"># Append the features to the original df</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>    <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                     <span class="n">roi_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                    <span class="n">properties_df1</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> 
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                   <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>    <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> 
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                    <span class="n">properties_df2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> 
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                   <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>    
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">df1</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">4</span><span class="p">:]:</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">feat</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Class&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution of </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1"> across classes&#39;</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Class&#39;</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2"> - non-numeric or contains inf/NaN.&quot;</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>    
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>    <span class="k">return</span> <span class="n">df1</span><span class="p">,</span> <span class="n">df2</span> 
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="k">def</span> <span class="nf">roi_features</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">    Extracts intensity-based statistical features from a list of ROI images and </span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">    optionally visualizes feature distributions across classes.</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">    </span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">    This function computes various intensity statistics such as max, min, mean,</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">    median, standard deviation, variance, skewness, and kurtosis for each</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">    Region of Interest (ROI). It associates these features with the corresponding </span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">    class labels from the input DataFrame.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">    </span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">    Parameters</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">    ----------</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">    rois : list of ndarray</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="sd">        List of 2D NumPy arrays representing grayscale ROI images.</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="sd">    </span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a><span class="sd">        DataFrame containing metadata for each ROI. Must include a &#39;Class&#39; </span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a><span class="sd">        column specifying the category of each ROI.</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">    </span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">    show : bool, optional (default=True)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">        If True, generates boxplots of each feature grouped by class for visual </span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">        comparison.</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="sd">    </span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">    out : int, optional (default=1)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">        Determines the format of the output:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">        - If 0: returns a new DataFrame containing only the computed features </span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="sd">                and class labels.</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">        - If 1: appends the computed features to the original DataFrame and </span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">                returns the result.</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">    </span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">    Returns</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">    -------</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">    pandas.DataFrame</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">        Depending on `out`:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">        - If out == 0: returns a new DataFrame with computed features and </span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">                       &#39;class&#39; column.</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">        - If out == 1: returns the original DataFrame with added columns for </span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">                        each computed feature.</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">    </span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="sd">    Notes</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="sd">    -----</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a><span class="sd">    - For empty ROIs, NaN is assigned to all computed features.</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a><span class="sd">    - The &#39;Class&#39; column is extracted from `df.Class` and is expected to be </span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="sd">      convertible to scalar.</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="sd">    </span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="c1"># Maximum intensity</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="s1">&#39;max&#39;</span>   <span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="c1"># Minimum intensity</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>        <span class="s1">&#39;min&#39;</span>   <span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="c1"># Mean intensity</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="s1">&#39;mean&#39;</span>  <span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="c1"># Median intensity</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>        <span class="c1"># Standard deviation</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="s1">&#39;stdev&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="c1"># Variance</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="s1">&#39;var&#39;</span>   <span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="c1"># Skewness (asymmetry of pixel intensity)</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="s1">&#39;skew&#39;</span>  <span class="p">:</span> <span class="p">[</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> \
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>                   <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="c1"># Kurtosis (peakedness of intensity distribution)</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>        <span class="s1">&#39;kurt&#39;</span>  <span class="p">:</span> <span class="p">[</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> \
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>                   <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="c1"># True Class</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="p">]</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>    <span class="p">}</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>    
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>    
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="c1"># Omit the last key (assumed to be &#39;class&#39;)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution of </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1"> across classes&#39;</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Class&#39;</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>    
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>    <span class="k">if</span> <span class="n">out</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> 
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="c1"># return new attributes</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>    
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>    <span class="k">elif</span> <span class="n">out</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>        <span class="c1"># return all attributes</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>        <span class="c1"># Drop duplicate &#39;class&#39; column to avoid conflicts</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="c1"># Append the features to the original df</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> 
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                        <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> 
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>                       <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="k">return</span> <span class="n">df</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a><span class="k">def</span> <span class="nf">corr_features</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">masks</span><span class="p">):</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a><span class="sd">    Calculates image-based correlation (normalized cross-correlation)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a><span class="sd">    between each ROI and each class-average mask using template matching.</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a><span class="sd">    Parameters:</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a><span class="sd">    -----------</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a><span class="sd">    rois : list of np.ndarray</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a><span class="sd">        List of 2D ROI images (grayscale). Each ROI should be of the same shape </span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">        as the corresponding masks for valid correlation computation.</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a><span class="sd">        DataFrame with one row per ROI. It must have at least the same length </span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a><span class="sd">        as `rois`. Expected to include a &#39;Class&#39; column, although it&#39;s not used </span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a><span class="sd">        directly in this function.</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="sd">    masks : dict or list of np.ndarray</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">        Class-average masks for template matching. Can be:</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="sd">            - A dictionary with keys like &#39;CorrCL1&#39;, &#39;CorrCL2&#39;, ..., &#39;CorrCL4&#39;.</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">            - A list of four masks (assumed ordered by class index 1 to 4).</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="sd">    Returns:</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">    --------</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">    pd.DataFrame</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">        DataFrame of shape (n_rois, 5), with:</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="sd">            - One column per class: correlation scores </span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a><span class="sd">            - A &#39;bestMatch&#39; column: integer from 1 to 4, indicating the class </span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a><span class="sd">                                    with max correlation.</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>    <span class="c1"># Convert list of masks to a dict with predefined class labels if needed</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>        <span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CorrCL1&quot;</span><span class="p">,</span> <span class="s2">&quot;CorrCL2&quot;</span><span class="p">,</span> <span class="s2">&quot;CorrCL3&quot;</span><span class="p">,</span> <span class="s2">&quot;CorrCL4&quot;</span><span class="p">]</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="n">mask_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">class_names</span><span class="p">,</span> <span class="n">masks</span><span class="p">)}</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>        <span class="n">mask_dict</span> <span class="o">=</span> <span class="n">masks</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>        <span class="n">class_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mask_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>    <span class="c1"># Will hold correlation scores per ROI</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>  
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>    <span class="c1"># Loop over each ROI image</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>    <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>        
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        <span class="c1"># Loop over each class mask and compute normalized cross-correlation</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">class_names</span><span class="p">:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_dict</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>            
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>            <span class="c1"># Check shape compatibility</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>            <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ROI and mask shapes must match.&quot;</span><span class="p">)</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>            <span class="c1"># Compute normalized cross-correlation using match_template</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="c1"># Since the ROI and mask are same-sized, the result is a single value</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>            <span class="n">ncc_score</span> <span class="o">=</span> <span class="n">match_template</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pad_input</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ncc_score</span><span class="p">)</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>        
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>        <span class="c1"># Save results</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>    <span class="c1"># Create a DataFrame from the correlation scores</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>    <span class="n">corr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ccorr</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">class_names</span><span class="p">])</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>    <span class="c1"># Identify the highest correlation score and corresponding class index</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>    <span class="n">corr_df</span><span class="p">[</span><span class="s2">&quot;maxCorr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>    
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>    <span class="c1"># Find which column had the max</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>    <span class="n">corr_df</span><span class="p">[</span><span class="s2">&quot;bestMatch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>    <span class="c1"># Extract the class number from the column name, e.g., &#39;ccorrCorrCL2&#39; → 2</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>    <span class="n">corr_df</span><span class="p">[</span><span class="s2">&quot;bestMatch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_df</span><span class="p">[</span><span class="s2">&quot;bestMatch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d)$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>    <span class="c1"># Drop intermediate maxCorr column (optional)</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>    <span class="n">corr_df</span> <span class="o">=</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;maxCorr&quot;</span><span class="p">])</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>    <span class="k">return</span> <span class="n">corr_df</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a><span class="k">def</span> <span class="nf">gauss_features</span><span class="p">(</span><span class="n">df_params</span><span class="p">):</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a><span class="sd">    Computes derived features from 2D Gaussian parameters.</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a><span class="sd">    Parameters</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a><span class="sd">    ----------</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a><span class="sd">    df_params : pandas.DataFrame</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a><span class="sd">        A DataFrame with columns: [&#39;class&#39;, &#39;amplitude&#39;, &#39;sigma_x&#39;, &#39;sigma_y&#39;, </span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a><span class="sd">         &#39;theta&#39;, &#39;offset&#39;]</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a><span class="sd">    Returns</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a><span class="sd">    -------</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a><span class="sd">    df_features : pandas.DataFrame</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a><span class="sd">        The input DataFrame with additional derived features: fwhm_x, fwhm_y, </span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a><span class="sd">        area, eccentricity, ellipticity, orientation_deg, peak_intensity, </span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a><span class="sd">        contrast, integrated_intensity</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>    <span class="c1"># Create a copy of the input dataframe to avoid modifying the original one</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>    <span class="c1"># Constants</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>    <span class="c1"># (a) The factor for calculating FWHM from sigma (standard deviation)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>    <span class="n">FWHM_factor</span> <span class="o">=</span> <span class="mf">2.355</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>    
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>    <span class="c1"># (b) Pi constant for area and other calculations</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>    <span class="n">pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>    <span class="c1"># Derived features based on Gaussian parameters</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>    <span class="c1"># (1) Full width at half maximum (FWHM) along x and y axes</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fwhm_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FWHM_factor</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">]</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fwhm_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FWHM_factor</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">]</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>    
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>    <span class="c1"># (2) Area of the Gaussian shape (in terms of the standard deviations)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;area2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">]</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>    
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>    <span class="c1"># (3) Eccentricity (how elongated the shape is, 0 = circular, 1 = linear)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eccentricity2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">],</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span> 
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>                                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>    
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>    <span class="c1"># (4) Ellipticity (ratio of sigma_x to sigma_y)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ellipticity2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">]</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>    
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>    <span class="c1"># (5) Orientation (the angle of rotation of the Gaussian in radians, </span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>    <span class="c1">#     converted to degrees)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;orientation_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">])</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>    
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>    <span class="c1"># (6) Peak intensity (the intensity at the peak of the Gaussian)</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>    
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>    <span class="c1"># (7) Contrast (normalized contrast of the peak)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>    <span class="c1">#     A small epsilon is added to avoid division by zero for cases where </span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>    <span class="c1">#     amplitude + offset is too small</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;contrast2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>  
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>    
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>    <span class="c1"># (8) Integrated intensity (total intensity under the Gaussian, related to</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>    <span class="c1">#     its area)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;integrated_intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">]</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>    
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>    <span class="c1"># Drop the &#39;x0&#39; and &#39;y0&#39; columns </span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>    <span class="c1"># errors=&#39;ignore&#39; to handle if &#39;x0&#39; or &#39;y0&#39; is missing</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a><span class="k">def</span> <span class="nf">gauss_params</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a><span class="sd">    Fits a 2D Gaussian function to each image (ROI) in the given list and </span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a><span class="sd">    returns the estimated parameters for each fit in a DataFrame.</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a><span class="sd">    Parameters</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a><span class="sd">    ----------</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a><span class="sd">    image_list : list of np.ndarray</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a><span class="sd">        A list of 2D NumPy arrays representing grayscale image regions (ROIs) </span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a><span class="sd">        where a Gaussian-like spot is expected.</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a><span class="sd">        DataFrame containing metadata for each ROI, including a &#39;Class&#39; column </span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a><span class="sd">        that assigns a label to each image.</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a><span class="sd">    Returns</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a><span class="sd">    -------</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a><span class="sd">    df_params : pandas.DataFrame</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a><span class="sd">        A DataFrame where each row corresponds to the parameters </span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a><span class="sd">        of a 2D Gaussian fit for an image in `image_list`. If a fit fails, </span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a><span class="sd">        the row contains NaNs.</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a><span class="sd">        Columns: class (label of the ROI), amplitude (peak height of the Gauss),</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a><span class="sd">                 x0, y0 (center coordinates), sigma_x (std deviation in x dir.),</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a><span class="sd">                 sigma_y  (std deviation in y direction), theta (rotation angle </span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a><span class="sd">                 of the Gaussian ellipse), offset (constant background level)</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>    <span class="c1"># Initialize variables</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>    <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">,</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">,</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">,</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> 
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>                   <span class="s1">&#39;offset&#39;</span><span class="p">]</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>    <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">clsx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]):</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>            <span class="c1"># Coordinate grid</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>            <span class="n">x_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>            <span class="c1"># Initial guess</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>            <span class="n">xo</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>            <span class="n">yo</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>            <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">sigma_y</span> <span class="o">=</span> <span class="mi">5</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>            <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">amplitude</span><span class="p">,</span> 
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>                             <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> 
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>                             <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> 
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>                             <span class="n">theta</span><span class="p">,</span> 
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>                             <span class="n">offset</span><span class="p">)</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>            <span class="c1"># Fit</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gauss2D</span><span class="p">,</span> 
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>                                <span class="n">x_data</span><span class="p">,</span> 
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>                                <span class="n">image</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> 
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>                                <span class="n">p0</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">,</span> 
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>                                <span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>            
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">clsx</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">popt</span><span class="p">))</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>            <span class="c1"># On failure, append NaNs</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">clsx</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>    <span class="n">df_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">param_names</span><span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>    <span class="k">return</span> <span class="n">df_params</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a><span class="k">def</span> <span class="nf">gauss2D</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a><span class="sd">    Computes a 2D Gaussian function with elliptical shape and rotation.</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a><span class="sd">    </span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a><span class="sd">    This function is typically used for curve fitting on 2D image data, </span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a><span class="sd">    such as intensity spots or blobs.</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a><span class="sd">    </span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a><span class="sd">    Parameters</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a><span class="sd">    ----------</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a><span class="sd">    xy : tuple of np.ndarray</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a><span class="sd">        A tuple of two flattened coordinate arrays (x, y), typically created</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a><span class="sd">        from a meshgrid and then stacked for curve fitting. Shape of each array </span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a><span class="sd">        should be (N,), where N is the number of pixels.</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a><span class="sd">    </span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a><span class="sd">    amplitude : float</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a><span class="sd">        Peak height of the Gaussian.</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a><span class="sd">    </span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a><span class="sd">    xo : float</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a><span class="sd">        X-coordinate of the Gaussian center.</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a><span class="sd">    </span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a><span class="sd">    yo : float</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a><span class="sd">        Y-coordinate of the Gaussian center.</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a><span class="sd">    </span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a><span class="sd">    sigma_x : float</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a><span class="sd">        Standard deviation in the x-direction.</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a><span class="sd">    </span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a><span class="sd">    sigma_y : float</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a><span class="sd">        Standard deviation in the y-direction.</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a><span class="sd">    </span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a><span class="sd">    theta : float</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a><span class="sd">        Rotation angle of the Gaussian (in radians), counterclockwise.</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a><span class="sd">    </span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a><span class="sd">    offset : float</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a><span class="sd">        Constant offset or background intensity.</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a><span class="sd">    </span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a><span class="sd">    Returns</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a><span class="sd">    -------</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a><span class="sd">    g : np.ndarray</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a><span class="sd">        The 2D Gaussian function values evaluated at the (x, y) coordinates,</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a><span class="sd">        returned as a 1D array (raveled). This is required by fitting functions</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a><span class="sd">        like `scipy.optimize.curve_fit`.</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>    <span class="c1"># Unpack flattened coordinate arrays</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>    <span class="n">xo</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>    <span class="n">yo</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">yo</span><span class="p">)</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>    
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>    <span class="c1"># Pre-compute constants for rotated Gaussian</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>    
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>    <span class="c1"># Compute 2D Gaussian function values</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>    <span class="n">g</span> <span class="o">=</span> <span class="n">offset</span><span class="o">+</span><span class="n">amplitude</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">xo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xo</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">yo</span><span class="p">)</span><span class="o">+</span><span class="n">c</span><span class="o">*</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">yo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>    
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>   
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>  <span class="c1"># Flatten for compatibility with curve_fit</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a><span class="k">def</span> <span class="nf">visualize_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">class_col</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a><span class="sd">    Visualize features in the dataframe using various methods.</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a><span class="sd">    Parameters:</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a><span class="sd">    ----------</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a><span class="sd">        DataFrame containing feature columns and a class label column.</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a><span class="sd">    method : str, optional (default=&quot;box&quot;)</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a><span class="sd">        Visualization method to use. Options are:</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a><span class="sd">            - &quot;box&quot; : Individual box plots for each feature grouped by class.</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a><span class="sd">            - &quot;pair&quot;: Pairwise scatter plots between features, color-coded </span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a><span class="sd">                      by class.</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a><span class="sd">            - &quot;heat&quot;: Heatmap of feature correlations.</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a><span class="sd">    show : bool, optional (default=True)</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a><span class="sd">        If method is &quot;box&quot;, show individual box plots for each feature.</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a><span class="sd">    class_col : str or None, optional (default=None)</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a><span class="sd">        Name of the class label column. If None, the function tries to infer </span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a><span class="sd">        the class column by looking for a column with &lt;10 unique values and </span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a><span class="sd">        categorical/object/integer dtype.</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a><span class="sd">    Returns:</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a><span class="sd">    -------</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a><span class="sd">        The original dataframe passed in, unchanged.</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a><span class="sd">    </span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a><span class="sd">    Raises:</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a><span class="sd">    ------</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a><span class="sd">    ValueError</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a><span class="sd">        If class_col cannot be inferred or if method is invalid or insufficient </span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a><span class="sd">        features are present for plotting.</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>    <span class="c1"># Try to infer class column if not provided</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>    <span class="k">if</span> <span class="n">class_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>                    <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">]:</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>                <span class="n">class_col</span> <span class="o">=</span> <span class="n">col</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>                <span class="k">break</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>        <span class="k">if</span> <span class="n">class_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>                <span class="s2">&quot;Could not determine class column. Please specify &#39;class_col&#39;.&quot;</span><span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>    <span class="c1"># Filter numeric feature columns</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>\
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>                    <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">class_col</span><span class="p">]</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;box&quot;</span><span class="p">:</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>        <span class="c1"># Box plot interpretation:</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>        <span class="c1"># - Box height (IQR): Spread of values</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>        <span class="c1"># - Median: Line inside the box</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>        <span class="c1"># - Whiskers: Range (excluding outliers)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>        <span class="c1"># - Outliers: Individual points</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>        <span class="c1"># Use case:</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>        <span class="c1"># - Feature distributions across classes</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a>        <span class="c1"># - Identify separable features</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>        
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>      <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>          <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>              <span class="c1"># Remove outliers based on IQR</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a>              <span class="n">Q1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a>              <span class="n">Q3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>              <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a>              <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a>              <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a>  
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>              <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">lower_bound</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">upper_bound</span><span class="p">)]</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>  
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>              <span class="c1"># Plot</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>              <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">class_col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">class_col</span><span class="p">,</span> 
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>                          <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution of </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1"> across classes (no outliers)&#39;</span><span class="p">)</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">class_col</span><span class="p">)</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a>          <span class="k">else</span><span class="p">:</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a>              <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2"> - contains inf/NaN.&quot;</span><span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a>        <span class="c1"># Pair plot interpretation:</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a>        <span class="c1"># - Each scatter plot shows how two features interact, color-coded b</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a>        <span class="c1">#   y class</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a>        <span class="c1"># - Diagonal shows feature distributions (histograms or KDEs)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a>        <span class="c1"># Use case:</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a>        <span class="c1"># - Identify feature combinations that separate classes</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a>        <span class="c1"># - Spot clusters or trends</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a>                <span class="s2">&quot;Need at least two numeric features to create a pairplot.&quot;</span><span class="p">)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a>        <span class="c1"># Remove outliers across all selected features using IQR</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a>        <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos">868</span></a>        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos">869</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos">870</span></a>              <span class="c1"># Remove outliers based on IQR</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos">871</span></a>              <span class="n">Q1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos">872</span></a>              <span class="n">Q3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos">873</span></a>              <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos">874</span></a>              <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos">875</span></a>              <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos">876</span></a>  
</span><span id="L-877"><a href="#L-877"><span class="linenos">877</span></a>              <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">lower_bound</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">upper_bound</span><span class="p">)]</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos">878</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos">879</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping outlier removal for </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2"> (contains inf/NaN)&quot;</span><span class="p">)</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos">880</span></a>    
</span><span id="L-881"><a href="#L-881"><span class="linenos">881</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">[</span><span class="n">feature_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">class_col</span><span class="p">]],</span> 
</span><span id="L-882"><a href="#L-882"><span class="linenos">882</span></a>                     <span class="n">hue</span><span class="o">=</span><span class="n">class_col</span><span class="p">,</span> 
</span><span id="L-883"><a href="#L-883"><span class="linenos">883</span></a>                     <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">)</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos">884</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Feature pairwise relationships by class (no outliers)&quot;</span><span class="p">,</span> 
</span><span id="L-885"><a href="#L-885"><span class="linenos">885</span></a>                     <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos">886</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos">887</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos">888</span></a>
</span><span id="L-889"><a href="#L-889"><span class="linenos">889</span></a>
</span><span id="L-890"><a href="#L-890"><span class="linenos">890</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;heat&quot;</span><span class="p">:</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos">891</span></a>        <span class="c1"># Heatmap interpretation:</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos">892</span></a>        <span class="c1"># - Shows correlation between all pairs of numeric features</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos">893</span></a>        <span class="c1"># - +1: Perfect positive correlation</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos">894</span></a>        <span class="c1"># -  0: No correlation</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos">895</span></a>        <span class="c1"># - -1: Perfect negative correlation</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos">896</span></a>        <span class="c1"># Use case:</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos">897</span></a>        <span class="c1"># - Detect redundant features (e.g., corr &gt; 0.8)</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos">898</span></a>        <span class="c1"># - Feature reduction or PCA</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos">899</span></a>        <span class="c1"># - Clustered heatmap can reveal groups of related features</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos">900</span></a>
</span><span id="L-901"><a href="#L-901"><span class="linenos">901</span></a>        <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos">902</span></a>        <span class="k">if</span> <span class="n">class_col</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos">903</span></a>            <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">feature_cols</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">class_col</span><span class="p">)</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos">904</span></a>        
</span><span id="L-905"><a href="#L-905"><span class="linenos">905</span></a>        <span class="c1"># Remove outliers from all numeric features using IQR</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos">906</span></a>        <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos">907</span></a>        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos">908</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos">909</span></a>                <span class="n">Q1</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos">910</span></a>                <span class="n">Q3</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos">911</span></a>                <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos">912</span></a>                <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos">913</span></a>                <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos">914</span></a>                <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[(</span><span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">&amp;</span> 
</span><span id="L-915"><a href="#L-915"><span class="linenos">915</span></a>                                          <span class="p">(</span><span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper_bound</span><span class="p">)]</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos">916</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos">917</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping outlier removal for </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2"> (contains inf/NaN)&quot;</span><span class="p">)</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos">918</span></a>            
</span><span id="L-919"><a href="#L-919"><span class="linenos">919</span></a>        <span class="n">corr</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos">920</span></a>
</span><span id="L-921"><a href="#L-921"><span class="linenos">921</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)),</span> 
</span><span id="L-922"><a href="#L-922"><span class="linenos">922</span></a>                            <span class="nb">max</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">))))</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos">923</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> 
</span><span id="L-924"><a href="#L-924"><span class="linenos">924</span></a>                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> 
</span><span id="L-925"><a href="#L-925"><span class="linenos">925</span></a>                    <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span><span id="L-926"><a href="#L-926"><span class="linenos">926</span></a>                    <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> 
</span><span id="L-927"><a href="#L-927"><span class="linenos">927</span></a>                    <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span><span id="L-928"><a href="#L-928"><span class="linenos">928</span></a>                    <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">.8</span><span class="p">})</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos">929</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Feature Correlation Heatmap&quot;</span><span class="p">)</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos">930</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos">931</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos">932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos">933</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos">934</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported method. Use &#39;box&#39;, &#39;pair&#39;, or &#39;heat&#39;.&quot;</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="get_features">
                            <input id="get_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">rois</span>, </span><span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">masks</span>, </span><span class="param"><span class="n">show</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_features-20"><a href="#get_features-20"><span class="linenos">20</span></a><span class="k">def</span> <span class="nf">get_features</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="get_features-21"><a href="#get_features-21"><span class="linenos">21</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_features-22"><a href="#get_features-22"><span class="linenos">22</span></a><span class="sd">    Extracts and combines multiple types of features from ROI images:</span>
</span><span id="get_features-23"><a href="#get_features-23"><span class="linenos">23</span></a><span class="sd">        - statistical</span>
</span><span id="get_features-24"><a href="#get_features-24"><span class="linenos">24</span></a><span class="sd">        - morphological</span>
</span><span id="get_features-25"><a href="#get_features-25"><span class="linenos">25</span></a><span class="sd">        - correlation-based</span>
</span><span id="get_features-26"><a href="#get_features-26"><span class="linenos">26</span></a><span class="sd">        - Gaussian-fitting features.</span>
</span><span id="get_features-27"><a href="#get_features-27"><span class="linenos">27</span></a>
</span><span id="get_features-28"><a href="#get_features-28"><span class="linenos">28</span></a><span class="sd">    Parameters:</span>
</span><span id="get_features-29"><a href="#get_features-29"><span class="linenos">29</span></a><span class="sd">    -----------</span>
</span><span id="get_features-30"><a href="#get_features-30"><span class="linenos">30</span></a><span class="sd">    rois : list of tuple</span>
</span><span id="get_features-31"><a href="#get_features-31"><span class="linenos">31</span></a><span class="sd">        List of tuples where each tuple is (roi, label), with:</span>
</span><span id="get_features-32"><a href="#get_features-32"><span class="linenos">32</span></a><span class="sd">        - roi : np.ndarray</span>
</span><span id="get_features-33"><a href="#get_features-33"><span class="linenos">33</span></a><span class="sd">            A 2D array representing the image of the ROI.</span>
</span><span id="get_features-34"><a href="#get_features-34"><span class="linenos">34</span></a><span class="sd">        - label : str or int</span>
</span><span id="get_features-35"><a href="#get_features-35"><span class="linenos">35</span></a><span class="sd">            Identifier or class label for the ROI.</span>
</span><span id="get_features-36"><a href="#get_features-36"><span class="linenos">36</span></a>
</span><span id="get_features-37"><a href="#get_features-37"><span class="linenos">37</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="get_features-38"><a href="#get_features-38"><span class="linenos">38</span></a><span class="sd">        DataFrame containing metadata for each ROI. It is expected to contain</span>
</span><span id="get_features-39"><a href="#get_features-39"><span class="linenos">39</span></a><span class="sd">        information like coordinates, class labels, and notes.</span>
</span><span id="get_features-40"><a href="#get_features-40"><span class="linenos">40</span></a>
</span><span id="get_features-41"><a href="#get_features-41"><span class="linenos">41</span></a><span class="sd">    masks : list of np.ndarray</span>
</span><span id="get_features-42"><a href="#get_features-42"><span class="linenos">42</span></a><span class="sd">        List of binary masks (same size as ROIs), where each mask defines the </span>
</span><span id="get_features-43"><a href="#get_features-43"><span class="linenos">43</span></a><span class="sd">        region of interest used for correlation feature extraction.</span>
</span><span id="get_features-44"><a href="#get_features-44"><span class="linenos">44</span></a>
</span><span id="get_features-45"><a href="#get_features-45"><span class="linenos">45</span></a><span class="sd">    show : bool, optional </span>
</span><span id="get_features-46"><a href="#get_features-46"><span class="linenos">46</span></a><span class="sd">        If True, displays visualizations during feature extraction (e.g., for </span>
</span><span id="get_features-47"><a href="#get_features-47"><span class="linenos">47</span></a><span class="sd">        verification). Default is False.</span>
</span><span id="get_features-48"><a href="#get_features-48"><span class="linenos">48</span></a>
</span><span id="get_features-49"><a href="#get_features-49"><span class="linenos">49</span></a><span class="sd">    Returns:</span>
</span><span id="get_features-50"><a href="#get_features-50"><span class="linenos">50</span></a><span class="sd">    --------</span>
</span><span id="get_features-51"><a href="#get_features-51"><span class="linenos">51</span></a><span class="sd">    combined_props : pandas.DataFrame</span>
</span><span id="get_features-52"><a href="#get_features-52"><span class="linenos">52</span></a><span class="sd">        A DataFrame containing all extracted features:</span>
</span><span id="get_features-53"><a href="#get_features-53"><span class="linenos">53</span></a><span class="sd">        - Statistical and morphological features</span>
</span><span id="get_features-54"><a href="#get_features-54"><span class="linenos">54</span></a><span class="sd">        - Gaussian fit parameters</span>
</span><span id="get_features-55"><a href="#get_features-55"><span class="linenos">55</span></a><span class="sd">        - Correlation-based features</span>
</span><span id="get_features-56"><a href="#get_features-56"><span class="linenos">56</span></a><span class="sd">        The class column is retained only once to avoid duplication.</span>
</span><span id="get_features-57"><a href="#get_features-57"><span class="linenos">57</span></a>
</span><span id="get_features-58"><a href="#get_features-58"><span class="linenos">58</span></a><span class="sd">    propsArr : np.ndarray</span>
</span><span id="get_features-59"><a href="#get_features-59"><span class="linenos">59</span></a><span class="sd">        A NumPy array containing additional features or summary statistics, </span>
</span><span id="get_features-60"><a href="#get_features-60"><span class="linenos">60</span></a><span class="sd">        typically used for low-dimensional numerical representation.</span>
</span><span id="get_features-61"><a href="#get_features-61"><span class="linenos">61</span></a>
</span><span id="get_features-62"><a href="#get_features-62"><span class="linenos">62</span></a><span class="sd">    Notes:</span>
</span><span id="get_features-63"><a href="#get_features-63"><span class="linenos">63</span></a><span class="sd">    ------</span>
</span><span id="get_features-64"><a href="#get_features-64"><span class="linenos">64</span></a><span class="sd">    - Internally calls:</span>
</span><span id="get_features-65"><a href="#get_features-65"><span class="linenos">65</span></a><span class="sd">        - `extended_features()` for statistical and morphological features</span>
</span><span id="get_features-66"><a href="#get_features-66"><span class="linenos">66</span></a><span class="sd">        - `corr_features()` for correlation metrics using masks</span>
</span><span id="get_features-67"><a href="#get_features-67"><span class="linenos">67</span></a><span class="sd">        - `gauss_params()` and `gauss_features()` for Gaussian fitting</span>
</span><span id="get_features-68"><a href="#get_features-68"><span class="linenos">68</span></a>
</span><span id="get_features-69"><a href="#get_features-69"><span class="linenos">69</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_features-70"><a href="#get_features-70"><span class="linenos">70</span></a>    
</span><span id="get_features-71"><a href="#get_features-71"><span class="linenos">71</span></a>    <span class="c1"># Access the first element (the ROI image) of each tuple</span>
</span><span id="get_features-72"><a href="#get_features-72"><span class="linenos">72</span></a>    <span class="n">rois_only</span> <span class="o">=</span> <span class="p">[</span><span class="n">roi_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">roi_data</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">]</span>  
</span><span id="get_features-73"><a href="#get_features-73"><span class="linenos">73</span></a>    
</span><span id="get_features-74"><a href="#get_features-74"><span class="linenos">74</span></a>    <span class="c1"># Compute statistical and morphological features </span>
</span><span id="get_features-75"><a href="#get_features-75"><span class="linenos">75</span></a>    <span class="n">propsFloat</span><span class="p">,</span> <span class="n">propsArr</span> <span class="o">=</span> <span class="n">extended_features</span><span class="p">(</span><span class="n">rois_only</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">show</span><span class="p">)</span>
</span><span id="get_features-76"><a href="#get_features-76"><span class="linenos">76</span></a>    
</span><span id="get_features-77"><a href="#get_features-77"><span class="linenos">77</span></a>    <span class="c1"># Compute correlation features</span>
</span><span id="get_features-78"><a href="#get_features-78"><span class="linenos">78</span></a>    <span class="n">propsCorr</span> <span class="o">=</span> <span class="n">corr_features</span><span class="p">(</span><span class="n">rois_only</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">masks</span><span class="p">)</span>
</span><span id="get_features-79"><a href="#get_features-79"><span class="linenos">79</span></a>    
</span><span id="get_features-80"><a href="#get_features-80"><span class="linenos">80</span></a>    <span class="c1"># Compute gaussian features</span>
</span><span id="get_features-81"><a href="#get_features-81"><span class="linenos">81</span></a>    <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss_params</span><span class="p">(</span><span class="n">rois_only</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</span><span id="get_features-82"><a href="#get_features-82"><span class="linenos">82</span></a>    <span class="n">propsGauss</span> <span class="o">=</span> <span class="n">gauss_features</span><span class="p">(</span><span class="n">gauss</span><span class="p">)</span>
</span><span id="get_features-83"><a href="#get_features-83"><span class="linenos">83</span></a>
</span><span id="get_features-84"><a href="#get_features-84"><span class="linenos">84</span></a>    <span class="c1"># Remove &#39;class&#39; column from one of the dataframes (propsGauss or propsFloat)</span>
</span><span id="get_features-85"><a href="#get_features-85"><span class="linenos">85</span></a>    <span class="n">propsGauss</span> <span class="o">=</span> <span class="n">propsGauss</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
</span><span id="get_features-86"><a href="#get_features-86"><span class="linenos">86</span></a>    
</span><span id="get_features-87"><a href="#get_features-87"><span class="linenos">87</span></a>    <span class="c1"># Concatenate the two dataframes along axis 1 (columns)</span>
</span><span id="get_features-88"><a href="#get_features-88"><span class="linenos">88</span></a>    <span class="n">combined_props</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">propsFloat</span><span class="p">,</span> <span class="n">propsGauss</span><span class="p">,</span> <span class="n">propsCorr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="get_features-89"><a href="#get_features-89"><span class="linenos">89</span></a>
</span><span id="get_features-90"><a href="#get_features-90"><span class="linenos">90</span></a>    <span class="k">return</span> <span class="n">combined_props</span><span class="p">,</span> <span class="n">propsArr</span>
</span></pre></div>


            <div class="docstring"><p>Extracts and combines multiple types of features from ROI images:
    - statistical
    - morphological
    - correlation-based
    - Gaussian-fitting features.</p>

<h2 id="parameters">Parameters:</h2>

<p>rois : list of tuple
    List of tuples where each tuple is (roi, label), with:
    - roi : np.ndarray
        A 2D array representing the image of the ROI.
    - label : str or int
        Identifier or class label for the ROI.</p>

<p>df : pandas.DataFrame
    DataFrame containing metadata for each ROI. It is expected to contain
    information like coordinates, class labels, and notes.</p>

<p>masks : list of np.ndarray
    List of binary masks (same size as ROIs), where each mask defines the 
    region of interest used for correlation feature extraction.</p>

<p>show : bool, optional 
    If True, displays visualizations during feature extraction (e.g., for 
    verification). Default is False.</p>

<h2 id="returns">Returns:</h2>

<p>combined_props : pandas.DataFrame
    A DataFrame containing all extracted features:
    - Statistical and morphological features
    - Gaussian fit parameters
    - Correlation-based features
    The class column is retained only once to avoid duplication.</p>

<p>propsArr : np.ndarray
    A NumPy array containing additional features or summary statistics, 
    typically used for low-dimensional numerical representation.</p>

<h2 id="notes">Notes:</h2>

<ul>
<li>Internally calls:
<ul>
<li><code><a href="#extended_features">extended_features()</a></code> for statistical and morphological features</li>
<li><code><a href="#corr_features">corr_features()</a></code> for correlation metrics using masks</li>
<li><code><a href="#gauss_params">gauss_params()</a></code> and <code><a href="#gauss_features">gauss_features()</a></code> for Gaussian fitting</li>
</ul></li>
</ul>
</div>


                </section>
                <section id="extended_features">
                            <input id="extended_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">extended_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">rois</span>, </span><span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">show</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="extended_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#extended_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="extended_features-93"><a href="#extended_features-93"><span class="linenos"> 93</span></a><span class="k">def</span> <span class="nf">extended_features</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="extended_features-94"><a href="#extended_features-94"><span class="linenos"> 94</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="extended_features-95"><a href="#extended_features-95"><span class="linenos"> 95</span></a><span class="sd">    Extracts and extends feature sets from a list of Region of Interest (ROI)</span>
</span><span id="extended_features-96"><a href="#extended_features-96"><span class="linenos"> 96</span></a><span class="sd">    images and returns two DataFrames containing scalar and array-based features </span>
</span><span id="extended_features-97"><a href="#extended_features-97"><span class="linenos"> 97</span></a><span class="sd">    respectively.</span>
</span><span id="extended_features-98"><a href="#extended_features-98"><span class="linenos"> 98</span></a>
</span><span id="extended_features-99"><a href="#extended_features-99"><span class="linenos"> 99</span></a><span class="sd">    The function computes basic ROI features via `roi_features()` and then </span>
</span><span id="extended_features-100"><a href="#extended_features-100"><span class="linenos">100</span></a><span class="sd">    performs additional morphological and shape analysis on each ROI, including </span>
</span><span id="extended_features-101"><a href="#extended_features-101"><span class="linenos">101</span></a><span class="sd">    thresholding (Otsu), morphological filtering, region labeling, and extraction </span>
</span><span id="extended_features-102"><a href="#extended_features-102"><span class="linenos">102</span></a><span class="sd">    of geometric and moment-based properties. </span>
</span><span id="extended_features-103"><a href="#extended_features-103"><span class="linenos">103</span></a>
</span><span id="extended_features-104"><a href="#extended_features-104"><span class="linenos">104</span></a><span class="sd">    Parameters</span>
</span><span id="extended_features-105"><a href="#extended_features-105"><span class="linenos">105</span></a><span class="sd">    ----------</span>
</span><span id="extended_features-106"><a href="#extended_features-106"><span class="linenos">106</span></a><span class="sd">    rois : list of ndarray</span>
</span><span id="extended_features-107"><a href="#extended_features-107"><span class="linenos">107</span></a><span class="sd">        List of 2D NumPy arrays, each representing an ROI (grayscale image).</span>
</span><span id="extended_features-108"><a href="#extended_features-108"><span class="linenos">108</span></a><span class="sd">    </span>
</span><span id="extended_features-109"><a href="#extended_features-109"><span class="linenos">109</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="extended_features-110"><a href="#extended_features-110"><span class="linenos">110</span></a><span class="sd">        DataFrame containing metadata associated with each ROI, including a </span>
</span><span id="extended_features-111"><a href="#extended_features-111"><span class="linenos">111</span></a><span class="sd">        &#39;Class&#39; column that specifies the particle category or label.</span>
</span><span id="extended_features-112"><a href="#extended_features-112"><span class="linenos">112</span></a><span class="sd">    </span>
</span><span id="extended_features-113"><a href="#extended_features-113"><span class="linenos">113</span></a><span class="sd">    show : bool, optional (default=True)</span>
</span><span id="extended_features-114"><a href="#extended_features-114"><span class="linenos">114</span></a><span class="sd">        If True, displays boxplots of each numeric feature grouped by class. </span>
</span><span id="extended_features-115"><a href="#extended_features-115"><span class="linenos">115</span></a><span class="sd">        Skips features that are non-numeric or contain NaN/inf.</span>
</span><span id="extended_features-116"><a href="#extended_features-116"><span class="linenos">116</span></a>
</span><span id="extended_features-117"><a href="#extended_features-117"><span class="linenos">117</span></a><span class="sd">    Returns</span>
</span><span id="extended_features-118"><a href="#extended_features-118"><span class="linenos">118</span></a><span class="sd">    -------</span>
</span><span id="extended_features-119"><a href="#extended_features-119"><span class="linenos">119</span></a><span class="sd">    df1 : pandas.DataFrame</span>
</span><span id="extended_features-120"><a href="#extended_features-120"><span class="linenos">120</span></a><span class="sd">        DataFrame with original `df` columns, features from `roi_features`, </span>
</span><span id="extended_features-121"><a href="#extended_features-121"><span class="linenos">121</span></a><span class="sd">        and additional scalar morphological features such as area, eccentricity, </span>
</span><span id="extended_features-122"><a href="#extended_features-122"><span class="linenos">122</span></a><span class="sd">        solidity, etc.</span>
</span><span id="extended_features-123"><a href="#extended_features-123"><span class="linenos">123</span></a><span class="sd">    </span>
</span><span id="extended_features-124"><a href="#extended_features-124"><span class="linenos">124</span></a><span class="sd">    df2 : pandas.DataFrame</span>
</span><span id="extended_features-125"><a href="#extended_features-125"><span class="linenos">125</span></a><span class="sd">        DataFrame with original `df` columns and array-based features including </span>
</span><span id="extended_features-126"><a href="#extended_features-126"><span class="linenos">126</span></a><span class="sd">        image moments and central moments for each ROI.</span>
</span><span id="extended_features-127"><a href="#extended_features-127"><span class="linenos">127</span></a><span class="sd">    </span>
</span><span id="extended_features-128"><a href="#extended_features-128"><span class="linenos">128</span></a><span class="sd">    Notes</span>
</span><span id="extended_features-129"><a href="#extended_features-129"><span class="linenos">129</span></a><span class="sd">    -----</span>
</span><span id="extended_features-130"><a href="#extended_features-130"><span class="linenos">130</span></a><span class="sd">    - For ROIs that are empty or contain uniform values, NaNs are assigned to </span>
</span><span id="extended_features-131"><a href="#extended_features-131"><span class="linenos">131</span></a><span class="sd">      all extracted features.</span>
</span><span id="extended_features-132"><a href="#extended_features-132"><span class="linenos">132</span></a><span class="sd">    - Features extracted include:</span>
</span><span id="extended_features-133"><a href="#extended_features-133"><span class="linenos">133</span></a><span class="sd">        - Scalar: area, convex area, eccentricity, solidity, equivalent diameter, </span>
</span><span id="extended_features-134"><a href="#extended_features-134"><span class="linenos">134</span></a><span class="sd">                  extent, number of pixels, orientation, and perimeter.</span>
</span><span id="extended_features-135"><a href="#extended_features-135"><span class="linenos">135</span></a><span class="sd">        - Array: raw spatial moments and central moments (both as 3x3 arrays).</span>
</span><span id="extended_features-136"><a href="#extended_features-136"><span class="linenos">136</span></a><span class="sd">    - The function assumes that the `df` DataFrame has the same number of rows </span>
</span><span id="extended_features-137"><a href="#extended_features-137"><span class="linenos">137</span></a><span class="sd">      as the number of ROIs provided, and that it includes a &#39;Class&#39; column for </span>
</span><span id="extended_features-138"><a href="#extended_features-138"><span class="linenos">138</span></a><span class="sd">      grouping.</span>
</span><span id="extended_features-139"><a href="#extended_features-139"><span class="linenos">139</span></a><span class="sd">    </span>
</span><span id="extended_features-140"><a href="#extended_features-140"><span class="linenos">140</span></a><span class="sd">    Raises</span>
</span><span id="extended_features-141"><a href="#extended_features-141"><span class="linenos">141</span></a><span class="sd">    ------</span>
</span><span id="extended_features-142"><a href="#extended_features-142"><span class="linenos">142</span></a><span class="sd">    Handles all exceptions during individual ROI processing and prints an error </span>
</span><span id="extended_features-143"><a href="#extended_features-143"><span class="linenos">143</span></a><span class="sd">    message.</span>
</span><span id="extended_features-144"><a href="#extended_features-144"><span class="linenos">144</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="extended_features-145"><a href="#extended_features-145"><span class="linenos">145</span></a>
</span><span id="extended_features-146"><a href="#extended_features-146"><span class="linenos">146</span></a>    <span class="n">binary</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="extended_features-147"><a href="#extended_features-147"><span class="linenos">147</span></a>    <span class="n">labeled</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="extended_features-148"><a href="#extended_features-148"><span class="linenos">148</span></a>    
</span><span id="extended_features-149"><a href="#extended_features-149"><span class="linenos">149</span></a>    <span class="c1"># This will hold dictionaries for each ROI with selected properties</span>
</span><span id="extended_features-150"><a href="#extended_features-150"><span class="linenos">150</span></a>    <span class="n">props_float</span> <span class="o">=</span> <span class="p">[]</span>  
</span><span id="extended_features-151"><a href="#extended_features-151"><span class="linenos">151</span></a>    <span class="n">props_arr</span> <span class="o">=</span> <span class="p">[]</span>  
</span><span id="extended_features-152"><a href="#extended_features-152"><span class="linenos">152</span></a>
</span><span id="extended_features-153"><a href="#extended_features-153"><span class="linenos">153</span></a>    <span class="n">roi_df</span> <span class="o">=</span> <span class="n">roi_features</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="extended_features-154"><a href="#extended_features-154"><span class="linenos">154</span></a>    
</span><span id="extended_features-155"><a href="#extended_features-155"><span class="linenos">155</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rois</span><span class="p">):</span>        <span class="c1"># Skip or handle empty arrays</span>
</span><span id="extended_features-156"><a href="#extended_features-156"><span class="linenos">156</span></a>        <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="extended_features-157"><a href="#extended_features-157"><span class="linenos">157</span></a>            <span class="n">binary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="extended_features-158"><a href="#extended_features-158"><span class="linenos">158</span></a>            <span class="n">labeled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="extended_features-159"><a href="#extended_features-159"><span class="linenos">159</span></a>            <span class="n">roi_properties1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="extended_features-160"><a href="#extended_features-160"><span class="linenos">160</span></a>                                <span class="s1">&#39;area_convex&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-161"><a href="#extended_features-161"><span class="linenos">161</span></a>                                <span class="s1">&#39;eccentricity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="extended_features-162"><a href="#extended_features-162"><span class="linenos">162</span></a>                                <span class="s1">&#39;solidity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-163"><a href="#extended_features-163"><span class="linenos">163</span></a>                                <span class="s1">&#39;equivalent_diameter_area&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-164"><a href="#extended_features-164"><span class="linenos">164</span></a>                                <span class="s1">&#39;extent&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-165"><a href="#extended_features-165"><span class="linenos">165</span></a>                                <span class="s1">&#39;num_pixels&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-166"><a href="#extended_features-166"><span class="linenos">166</span></a>                                <span class="s1">&#39;orientation&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-167"><a href="#extended_features-167"><span class="linenos">167</span></a>                                <span class="s1">&#39;perimeter&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-168"><a href="#extended_features-168"><span class="linenos">168</span></a>                                <span class="s1">&#39;otsu&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-169"><a href="#extended_features-169"><span class="linenos">169</span></a>                                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="extended_features-170"><a href="#extended_features-170"><span class="linenos">170</span></a>                                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="extended_features-171"><a href="#extended_features-171"><span class="linenos">171</span></a>                                    <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="extended_features-172"><a href="#extended_features-172"><span class="linenos">172</span></a>                                <span class="p">}</span>
</span><span id="extended_features-173"><a href="#extended_features-173"><span class="linenos">173</span></a>            
</span><span id="extended_features-174"><a href="#extended_features-174"><span class="linenos">174</span></a>            <span class="n">roi_properties2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;moments&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-175"><a href="#extended_features-175"><span class="linenos">175</span></a>                              <span class="s1">&#39;moments_central&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-176"><a href="#extended_features-176"><span class="linenos">176</span></a>                              <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="extended_features-177"><a href="#extended_features-177"><span class="linenos">177</span></a>                                        <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="p">],</span>
</span><span id="extended_features-178"><a href="#extended_features-178"><span class="linenos">178</span></a>                              <span class="p">}</span>
</span><span id="extended_features-179"><a href="#extended_features-179"><span class="linenos">179</span></a>            <span class="n">props_float</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties1</span><span class="p">)</span>
</span><span id="extended_features-180"><a href="#extended_features-180"><span class="linenos">180</span></a>            <span class="n">props_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties2</span><span class="p">)</span>
</span><span id="extended_features-181"><a href="#extended_features-181"><span class="linenos">181</span></a>            <span class="k">continue</span>
</span><span id="extended_features-182"><a href="#extended_features-182"><span class="linenos">182</span></a>
</span><span id="extended_features-183"><a href="#extended_features-183"><span class="linenos">183</span></a>        <span class="c1"># Replace NaNs with 0 (or another strategy)</span>
</span><span id="extended_features-184"><a href="#extended_features-184"><span class="linenos">184</span></a>        <span class="n">roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
</span><span id="extended_features-185"><a href="#extended_features-185"><span class="linenos">185</span></a>        
</span><span id="extended_features-186"><a href="#extended_features-186"><span class="linenos">186</span></a>        <span class="c1"># Skip if all values are the same (e.g., all 0)</span>
</span><span id="extended_features-187"><a href="#extended_features-187"><span class="linenos">187</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">roi</span> <span class="o">==</span> <span class="n">roi</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="extended_features-188"><a href="#extended_features-188"><span class="linenos">188</span></a>            <span class="n">binary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="extended_features-189"><a href="#extended_features-189"><span class="linenos">189</span></a>            <span class="n">labeled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="extended_features-190"><a href="#extended_features-190"><span class="linenos">190</span></a>            <span class="n">roi_properties1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="extended_features-191"><a href="#extended_features-191"><span class="linenos">191</span></a>                                <span class="s1">&#39;area_convex&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-192"><a href="#extended_features-192"><span class="linenos">192</span></a>                                <span class="s1">&#39;eccentricity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="extended_features-193"><a href="#extended_features-193"><span class="linenos">193</span></a>                                <span class="s1">&#39;solidity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-194"><a href="#extended_features-194"><span class="linenos">194</span></a>                                <span class="s1">&#39;equivalent_diameter_area&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-195"><a href="#extended_features-195"><span class="linenos">195</span></a>                                <span class="s1">&#39;extent&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-196"><a href="#extended_features-196"><span class="linenos">196</span></a>                                <span class="s1">&#39;num_pixels&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-197"><a href="#extended_features-197"><span class="linenos">197</span></a>                                <span class="s1">&#39;orientation&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-198"><a href="#extended_features-198"><span class="linenos">198</span></a>                                <span class="s1">&#39;perimeter&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-199"><a href="#extended_features-199"><span class="linenos">199</span></a>                                <span class="s1">&#39;otsu&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-200"><a href="#extended_features-200"><span class="linenos">200</span></a>                                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="extended_features-201"><a href="#extended_features-201"><span class="linenos">201</span></a>                                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="extended_features-202"><a href="#extended_features-202"><span class="linenos">202</span></a>                                    <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="extended_features-203"><a href="#extended_features-203"><span class="linenos">203</span></a>                                <span class="p">}</span>
</span><span id="extended_features-204"><a href="#extended_features-204"><span class="linenos">204</span></a>            
</span><span id="extended_features-205"><a href="#extended_features-205"><span class="linenos">205</span></a>            <span class="n">roi_properties2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;moments&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-206"><a href="#extended_features-206"><span class="linenos">206</span></a>                              <span class="s1">&#39;moments_central&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-207"><a href="#extended_features-207"><span class="linenos">207</span></a>                              <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="extended_features-208"><a href="#extended_features-208"><span class="linenos">208</span></a>                                  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="extended_features-209"><a href="#extended_features-209"><span class="linenos">209</span></a>                                  <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="extended_features-210"><a href="#extended_features-210"><span class="linenos">210</span></a>                              <span class="p">}</span>
</span><span id="extended_features-211"><a href="#extended_features-211"><span class="linenos">211</span></a>                
</span><span id="extended_features-212"><a href="#extended_features-212"><span class="linenos">212</span></a>            <span class="n">props_float</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties1</span><span class="p">)</span>
</span><span id="extended_features-213"><a href="#extended_features-213"><span class="linenos">213</span></a>            <span class="n">props_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties2</span><span class="p">)</span>
</span><span id="extended_features-214"><a href="#extended_features-214"><span class="linenos">214</span></a>            <span class="k">continue</span>
</span><span id="extended_features-215"><a href="#extended_features-215"><span class="linenos">215</span></a>
</span><span id="extended_features-216"><a href="#extended_features-216"><span class="linenos">216</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="extended_features-217"><a href="#extended_features-217"><span class="linenos">217</span></a>            <span class="c1"># Get threshold using Otsu method</span>
</span><span id="extended_features-218"><a href="#extended_features-218"><span class="linenos">218</span></a>            <span class="c1"># TODO zamyslet se, jestli by nebylo lepsi pouzivat 1 globalni </span>
</span><span id="extended_features-219"><a href="#extended_features-219"><span class="linenos">219</span></a>            <span class="c1"># threshold pro vsechny nanocastice</span>
</span><span id="extended_features-220"><a href="#extended_features-220"><span class="linenos">220</span></a>            <span class="n">thresh</span> <span class="o">=</span> <span class="n">threshold_otsu</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
</span><span id="extended_features-221"><a href="#extended_features-221"><span class="linenos">221</span></a>            <span class="n">binim</span> <span class="o">=</span> <span class="n">roi</span> <span class="o">&gt;</span> <span class="n">thresh</span>
</span><span id="extended_features-222"><a href="#extended_features-222"><span class="linenos">222</span></a>            
</span><span id="extended_features-223"><a href="#extended_features-223"><span class="linenos">223</span></a>            <span class="c1"># Apply morphological opening to remove small noise</span>
</span><span id="extended_features-224"><a href="#extended_features-224"><span class="linenos">224</span></a>            <span class="n">binim_filtered</span> <span class="o">=</span> <span class="n">opening</span><span class="p">(</span><span class="n">binim</span><span class="p">,</span> <span class="n">disk</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  
</span><span id="extended_features-225"><a href="#extended_features-225"><span class="linenos">225</span></a>            <span class="n">binary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binim_filtered</span><span class="p">)</span>
</span><span id="extended_features-226"><a href="#extended_features-226"><span class="linenos">226</span></a>            
</span><span id="extended_features-227"><a href="#extended_features-227"><span class="linenos">227</span></a>            <span class="c1"># Label the filtered binary image</span>
</span><span id="extended_features-228"><a href="#extended_features-228"><span class="linenos">228</span></a>            <span class="n">lab</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">binim_filtered</span><span class="p">)</span>
</span><span id="extended_features-229"><a href="#extended_features-229"><span class="linenos">229</span></a>            <span class="n">labeled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span> 
</span><span id="extended_features-230"><a href="#extended_features-230"><span class="linenos">230</span></a>            
</span><span id="extended_features-231"><a href="#extended_features-231"><span class="linenos">231</span></a>            <span class="c1"># Calculate region properties</span>
</span><span id="extended_features-232"><a href="#extended_features-232"><span class="linenos">232</span></a>            <span class="n">regions</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span>
</span><span id="extended_features-233"><a href="#extended_features-233"><span class="linenos">233</span></a>            
</span><span id="extended_features-234"><a href="#extended_features-234"><span class="linenos">234</span></a>            <span class="c1"># Initialize a dictionary to store selected properties for this ROI</span>
</span><span id="extended_features-235"><a href="#extended_features-235"><span class="linenos">235</span></a>            <span class="n">roi_properties1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="extended_features-236"><a href="#extended_features-236"><span class="linenos">236</span></a>                                <span class="s1">&#39;area_convex&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-237"><a href="#extended_features-237"><span class="linenos">237</span></a>                                <span class="s1">&#39;eccentricity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="extended_features-238"><a href="#extended_features-238"><span class="linenos">238</span></a>                                <span class="s1">&#39;solidity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-239"><a href="#extended_features-239"><span class="linenos">239</span></a>                                <span class="s1">&#39;equivalent_diameter_area&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-240"><a href="#extended_features-240"><span class="linenos">240</span></a>                                <span class="s1">&#39;extent&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-241"><a href="#extended_features-241"><span class="linenos">241</span></a>                                <span class="s1">&#39;num_pixels&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-242"><a href="#extended_features-242"><span class="linenos">242</span></a>                                <span class="s1">&#39;orientation&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-243"><a href="#extended_features-243"><span class="linenos">243</span></a>                                <span class="s1">&#39;perimeter&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-244"><a href="#extended_features-244"><span class="linenos">244</span></a>                                <span class="s1">&#39;otsu&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-245"><a href="#extended_features-245"><span class="linenos">245</span></a>                                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="extended_features-246"><a href="#extended_features-246"><span class="linenos">246</span></a>                                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="extended_features-247"><a href="#extended_features-247"><span class="linenos">247</span></a>                                    <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="extended_features-248"><a href="#extended_features-248"><span class="linenos">248</span></a>                                <span class="p">}</span>
</span><span id="extended_features-249"><a href="#extended_features-249"><span class="linenos">249</span></a>            
</span><span id="extended_features-250"><a href="#extended_features-250"><span class="linenos">250</span></a>            <span class="n">roi_properties2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;moments&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-251"><a href="#extended_features-251"><span class="linenos">251</span></a>                              <span class="s1">&#39;moments_central&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-252"><a href="#extended_features-252"><span class="linenos">252</span></a>                              <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="extended_features-253"><a href="#extended_features-253"><span class="linenos">253</span></a>                                  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="extended_features-254"><a href="#extended_features-254"><span class="linenos">254</span></a>                                  <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="extended_features-255"><a href="#extended_features-255"><span class="linenos">255</span></a>                              <span class="p">}</span>
</span><span id="extended_features-256"><a href="#extended_features-256"><span class="linenos">256</span></a>            
</span><span id="extended_features-257"><a href="#extended_features-257"><span class="linenos">257</span></a>            <span class="k">if</span> <span class="n">regions</span><span class="p">:</span>
</span><span id="extended_features-258"><a href="#extended_features-258"><span class="linenos">258</span></a>                <span class="n">region</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="extended_features-259"><a href="#extended_features-259"><span class="linenos">259</span></a>                
</span><span id="extended_features-260"><a href="#extended_features-260"><span class="linenos">260</span></a>                <span class="c1"># Add properties you want to track</span>
</span><span id="extended_features-261"><a href="#extended_features-261"><span class="linenos">261</span></a>                <span class="c1"># (1) AREA OF THE REGION (number of pixels of the region </span>
</span><span id="extended_features-262"><a href="#extended_features-262"><span class="linenos">262</span></a>                <span class="c1"># scaled by pixel-area)</span>
</span><span id="extended_features-263"><a href="#extended_features-263"><span class="linenos">263</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">area</span> 
</span><span id="extended_features-264"><a href="#extended_features-264"><span class="linenos">264</span></a>                
</span><span id="extended_features-265"><a href="#extended_features-265"><span class="linenos">265</span></a>                <span class="c1"># (2) AREA OF THE CONVEX HULL IMAGE (the smallest convex polygon </span>
</span><span id="extended_features-266"><a href="#extended_features-266"><span class="linenos">266</span></a>                <span class="c1"># that encloses the region)</span>
</span><span id="extended_features-267"><a href="#extended_features-267"><span class="linenos">267</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;area_convex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">area_convex</span>
</span><span id="extended_features-268"><a href="#extended_features-268"><span class="linenos">268</span></a>                
</span><span id="extended_features-269"><a href="#extended_features-269"><span class="linenos">269</span></a>                <span class="c1"># (3) ECCENTRICITY (the ratio of the focal distance (distance </span>
</span><span id="extended_features-270"><a href="#extended_features-270"><span class="linenos">270</span></a>                <span class="c1"># between focal points) over the major axis length. The value </span>
</span><span id="extended_features-271"><a href="#extended_features-271"><span class="linenos">271</span></a>                <span class="c1"># is in the interval [0, 1). When it is 0, the ellipse becomes </span>
</span><span id="extended_features-272"><a href="#extended_features-272"><span class="linenos">272</span></a>                <span class="c1"># a circle.</span>
</span><span id="extended_features-273"><a href="#extended_features-273"><span class="linenos">273</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;eccentricity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">eccentricity</span>
</span><span id="extended_features-274"><a href="#extended_features-274"><span class="linenos">274</span></a>                
</span><span id="extended_features-275"><a href="#extended_features-275"><span class="linenos">275</span></a>                <span class="c1"># (4) SOLIDITY (Ratio of pixels in the region to pixels of the </span>
</span><span id="extended_features-276"><a href="#extended_features-276"><span class="linenos">276</span></a>                <span class="c1"># convex hull image.)</span>
</span><span id="extended_features-277"><a href="#extended_features-277"><span class="linenos">277</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;solidity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">solidity</span>
</span><span id="extended_features-278"><a href="#extended_features-278"><span class="linenos">278</span></a>                
</span><span id="extended_features-279"><a href="#extended_features-279"><span class="linenos">279</span></a>                <span class="c1"># (5) EQUIVALENT DIAMETER AREA (the diameter of a circle with </span>
</span><span id="extended_features-280"><a href="#extended_features-280"><span class="linenos">280</span></a>                <span class="c1"># the same area as the region)</span>
</span><span id="extended_features-281"><a href="#extended_features-281"><span class="linenos">281</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;equivalent_diameter_area&#39;</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="extended_features-282"><a href="#extended_features-282"><span class="linenos">282</span></a>                    <span class="n">region</span><span class="o">.</span><span class="n">equivalent_diameter_area</span>
</span><span id="extended_features-283"><a href="#extended_features-283"><span class="linenos">283</span></a>                
</span><span id="extended_features-284"><a href="#extended_features-284"><span class="linenos">284</span></a>                <span class="c1"># (6) EXTENT (ratio of pixels in the region to pixels in the </span>
</span><span id="extended_features-285"><a href="#extended_features-285"><span class="linenos">285</span></a>                <span class="c1"># total bounding box. Computed as area / (rows * cols))</span>
</span><span id="extended_features-286"><a href="#extended_features-286"><span class="linenos">286</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;extent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">extent</span>
</span><span id="extended_features-287"><a href="#extended_features-287"><span class="linenos">287</span></a>                
</span><span id="extended_features-288"><a href="#extended_features-288"><span class="linenos">288</span></a>                <span class="c1"># (7) NUMBER OF PIXELS (number of foreground pixels)</span>
</span><span id="extended_features-289"><a href="#extended_features-289"><span class="linenos">289</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;num_pixels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">num_pixels</span>
</span><span id="extended_features-290"><a href="#extended_features-290"><span class="linenos">290</span></a>                
</span><span id="extended_features-291"><a href="#extended_features-291"><span class="linenos">291</span></a>                <span class="c1"># (8) ORIENTATION (angle between the 0th axis (rows) and the </span>
</span><span id="extended_features-292"><a href="#extended_features-292"><span class="linenos">292</span></a>                <span class="c1"># major axis of the ellipse that has the same second moments </span>
</span><span id="extended_features-293"><a href="#extended_features-293"><span class="linenos">293</span></a>                <span class="c1"># as the region, ranging from -pi/2 to pi/2 counter-clockwise.)</span>
</span><span id="extended_features-294"><a href="#extended_features-294"><span class="linenos">294</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">orientation</span>
</span><span id="extended_features-295"><a href="#extended_features-295"><span class="linenos">295</span></a>                
</span><span id="extended_features-296"><a href="#extended_features-296"><span class="linenos">296</span></a>                <span class="c1"># (9) PERIMETER (Perimeter of object which approximates the </span>
</span><span id="extended_features-297"><a href="#extended_features-297"><span class="linenos">297</span></a>                <span class="c1"># contour as a line through the centers of border pixels using </span>
</span><span id="extended_features-298"><a href="#extended_features-298"><span class="linenos">298</span></a>                <span class="c1"># a 4-connectivity.)</span>
</span><span id="extended_features-299"><a href="#extended_features-299"><span class="linenos">299</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;perimeter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">perimeter</span>
</span><span id="extended_features-300"><a href="#extended_features-300"><span class="linenos">300</span></a>                
</span><span id="extended_features-301"><a href="#extended_features-301"><span class="linenos">301</span></a>                <span class="c1"># (10) OTSU THRESHOLD</span>
</span><span id="extended_features-302"><a href="#extended_features-302"><span class="linenos">302</span></a>                <span class="n">roi_properties1</span><span class="p">[</span><span class="s1">&#39;otsu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh</span>
</span><span id="extended_features-303"><a href="#extended_features-303"><span class="linenos">303</span></a>                
</span><span id="extended_features-304"><a href="#extended_features-304"><span class="linenos">304</span></a>                <span class="c1"># (10) MOMENTS (spatial moments up to 3rd order, 3x3 array)</span>
</span><span id="extended_features-305"><a href="#extended_features-305"><span class="linenos">305</span></a>                <span class="n">roi_properties2</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">moments</span>
</span><span id="extended_features-306"><a href="#extended_features-306"><span class="linenos">306</span></a>                
</span><span id="extended_features-307"><a href="#extended_features-307"><span class="linenos">307</span></a>                <span class="c1"># (11) MOMENTS CENTRAL (central moments (translation invariant) </span>
</span><span id="extended_features-308"><a href="#extended_features-308"><span class="linenos">308</span></a>                <span class="c1"># up to 3rd order, 3x3 array)</span>
</span><span id="extended_features-309"><a href="#extended_features-309"><span class="linenos">309</span></a>                <span class="n">roi_properties2</span><span class="p">[</span><span class="s1">&#39;moments_central&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">moments_central</span>
</span><span id="extended_features-310"><a href="#extended_features-310"><span class="linenos">310</span></a>                
</span><span id="extended_features-311"><a href="#extended_features-311"><span class="linenos">311</span></a>            
</span><span id="extended_features-312"><a href="#extended_features-312"><span class="linenos">312</span></a>                
</span><span id="extended_features-313"><a href="#extended_features-313"><span class="linenos">313</span></a>
</span><span id="extended_features-314"><a href="#extended_features-314"><span class="linenos">314</span></a>            <span class="c1"># Append the properties dictionary for this ROI</span>
</span><span id="extended_features-315"><a href="#extended_features-315"><span class="linenos">315</span></a>            <span class="c1"># FLOAT properties</span>
</span><span id="extended_features-316"><a href="#extended_features-316"><span class="linenos">316</span></a>            <span class="n">props_float</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties1</span><span class="p">)</span>
</span><span id="extended_features-317"><a href="#extended_features-317"><span class="linenos">317</span></a>            
</span><span id="extended_features-318"><a href="#extended_features-318"><span class="linenos">318</span></a>            <span class="c1"># ARRAY properties</span>
</span><span id="extended_features-319"><a href="#extended_features-319"><span class="linenos">319</span></a>            <span class="n">props_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_properties2</span><span class="p">)</span>
</span><span id="extended_features-320"><a href="#extended_features-320"><span class="linenos">320</span></a>            
</span><span id="extended_features-321"><a href="#extended_features-321"><span class="linenos">321</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="extended_features-322"><a href="#extended_features-322"><span class="linenos">322</span></a>            <span class="c1"># Catch unexpected errors and handle them gracefully</span>
</span><span id="extended_features-323"><a href="#extended_features-323"><span class="linenos">323</span></a>            <span class="n">binary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="extended_features-324"><a href="#extended_features-324"><span class="linenos">324</span></a>            <span class="n">labeled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="extended_features-325"><a href="#extended_features-325"><span class="linenos">325</span></a>            
</span><span id="extended_features-326"><a href="#extended_features-326"><span class="linenos">326</span></a>            <span class="c1"># FLOAT properties</span>
</span><span id="extended_features-327"><a href="#extended_features-327"><span class="linenos">327</span></a>            <span class="n">props_float</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="extended_features-328"><a href="#extended_features-328"><span class="linenos">328</span></a>                                    <span class="s1">&#39;area_convex&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-329"><a href="#extended_features-329"><span class="linenos">329</span></a>                                    <span class="s1">&#39;eccentricity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
</span><span id="extended_features-330"><a href="#extended_features-330"><span class="linenos">330</span></a>                                    <span class="s1">&#39;solidity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-331"><a href="#extended_features-331"><span class="linenos">331</span></a>                                    <span class="s1">&#39;equivalent_diameter_area&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-332"><a href="#extended_features-332"><span class="linenos">332</span></a>                                    <span class="s1">&#39;extent&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-333"><a href="#extended_features-333"><span class="linenos">333</span></a>                                    <span class="s1">&#39;num_pixels&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-334"><a href="#extended_features-334"><span class="linenos">334</span></a>                                    <span class="s1">&#39;orientation&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-335"><a href="#extended_features-335"><span class="linenos">335</span></a>                                    <span class="s1">&#39;perimeter&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-336"><a href="#extended_features-336"><span class="linenos">336</span></a>                                    <span class="s1">&#39;otsu&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-337"><a href="#extended_features-337"><span class="linenos">337</span></a>                                    <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="extended_features-338"><a href="#extended_features-338"><span class="linenos">338</span></a>                                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="extended_features-339"><a href="#extended_features-339"><span class="linenos">339</span></a>                                        <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="extended_features-340"><a href="#extended_features-340"><span class="linenos">340</span></a>                                    <span class="p">})</span>
</span><span id="extended_features-341"><a href="#extended_features-341"><span class="linenos">341</span></a>            
</span><span id="extended_features-342"><a href="#extended_features-342"><span class="linenos">342</span></a>            <span class="c1"># ARRAY properties</span>
</span><span id="extended_features-343"><a href="#extended_features-343"><span class="linenos">343</span></a>            <span class="n">props_arr</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;moments&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-344"><a href="#extended_features-344"><span class="linenos">344</span></a>                              <span class="s1">&#39;moments_central&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
</span><span id="extended_features-345"><a href="#extended_features-345"><span class="linenos">345</span></a>                              <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> \
</span><span id="extended_features-346"><a href="#extended_features-346"><span class="linenos">346</span></a>                                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> 
</span><span id="extended_features-347"><a href="#extended_features-347"><span class="linenos">347</span></a>                                    <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="extended_features-348"><a href="#extended_features-348"><span class="linenos">348</span></a>                                <span class="p">})</span>
</span><span id="extended_features-349"><a href="#extended_features-349"><span class="linenos">349</span></a>            
</span><span id="extended_features-350"><a href="#extended_features-350"><span class="linenos">350</span></a>            
</span><span id="extended_features-351"><a href="#extended_features-351"><span class="linenos">351</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping ROI due to error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="extended_features-352"><a href="#extended_features-352"><span class="linenos">352</span></a>    
</span><span id="extended_features-353"><a href="#extended_features-353"><span class="linenos">353</span></a>    <span class="c1"># Convert the list of dictionaries to a pandas DataFrame</span>
</span><span id="extended_features-354"><a href="#extended_features-354"><span class="linenos">354</span></a>    <span class="n">properties_df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">props_float</span><span class="p">)</span>
</span><span id="extended_features-355"><a href="#extended_features-355"><span class="linenos">355</span></a>
</span><span id="extended_features-356"><a href="#extended_features-356"><span class="linenos">356</span></a>    <span class="n">properties_df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">props_arr</span><span class="p">)</span>
</span><span id="extended_features-357"><a href="#extended_features-357"><span class="linenos">357</span></a>
</span><span id="extended_features-358"><a href="#extended_features-358"><span class="linenos">358</span></a>    <span class="c1"># If any rows have missing data (None), fill those rows with NaN</span>
</span><span id="extended_features-359"><a href="#extended_features-359"><span class="linenos">359</span></a>    <span class="n">properties_df1</span> <span class="o">=</span> <span class="n">properties_df1</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  
</span><span id="extended_features-360"><a href="#extended_features-360"><span class="linenos">360</span></a>    <span class="n">properties_df2</span> <span class="o">=</span> <span class="n">properties_df2</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  
</span><span id="extended_features-361"><a href="#extended_features-361"><span class="linenos">361</span></a>                 
</span><span id="extended_features-362"><a href="#extended_features-362"><span class="linenos">362</span></a>    
</span><span id="extended_features-363"><a href="#extended_features-363"><span class="linenos">363</span></a>    <span class="c1"># Drop duplicate &#39;class&#39; column to avoid conflicts</span>
</span><span id="extended_features-364"><a href="#extended_features-364"><span class="linenos">364</span></a>    <span class="n">roi_df</span> <span class="o">=</span> <span class="n">roi_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
</span><span id="extended_features-365"><a href="#extended_features-365"><span class="linenos">365</span></a>    <span class="n">properties_df1</span> <span class="o">=</span> <span class="n">properties_df1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
</span><span id="extended_features-366"><a href="#extended_features-366"><span class="linenos">366</span></a>    <span class="n">properties_df2</span> <span class="o">=</span> <span class="n">properties_df2</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
</span><span id="extended_features-367"><a href="#extended_features-367"><span class="linenos">367</span></a>
</span><span id="extended_features-368"><a href="#extended_features-368"><span class="linenos">368</span></a>
</span><span id="extended_features-369"><a href="#extended_features-369"><span class="linenos">369</span></a>    <span class="c1"># Append the features to the original df</span>
</span><span id="extended_features-370"><a href="#extended_features-370"><span class="linenos">370</span></a>    <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="extended_features-371"><a href="#extended_features-371"><span class="linenos">371</span></a>                     <span class="n">roi_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
</span><span id="extended_features-372"><a href="#extended_features-372"><span class="linenos">372</span></a>                    <span class="n">properties_df1</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> 
</span><span id="extended_features-373"><a href="#extended_features-373"><span class="linenos">373</span></a>                   <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="extended_features-374"><a href="#extended_features-374"><span class="linenos">374</span></a>    <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> 
</span><span id="extended_features-375"><a href="#extended_features-375"><span class="linenos">375</span></a>                    <span class="n">properties_df2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> 
</span><span id="extended_features-376"><a href="#extended_features-376"><span class="linenos">376</span></a>                   <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="extended_features-377"><a href="#extended_features-377"><span class="linenos">377</span></a>    
</span><span id="extended_features-378"><a href="#extended_features-378"><span class="linenos">378</span></a>    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
</span><span id="extended_features-379"><a href="#extended_features-379"><span class="linenos">379</span></a>        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">df1</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">4</span><span class="p">:]:</span>
</span><span id="extended_features-380"><a href="#extended_features-380"><span class="linenos">380</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="n">feat</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="extended_features-381"><a href="#extended_features-381"><span class="linenos">381</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="extended_features-382"><a href="#extended_features-382"><span class="linenos">382</span></a>                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Class&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">)</span>
</span><span id="extended_features-383"><a href="#extended_features-383"><span class="linenos">383</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution of </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1"> across classes&#39;</span><span class="p">)</span>
</span><span id="extended_features-384"><a href="#extended_features-384"><span class="linenos">384</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Class&#39;</span><span class="p">)</span>
</span><span id="extended_features-385"><a href="#extended_features-385"><span class="linenos">385</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
</span><span id="extended_features-386"><a href="#extended_features-386"><span class="linenos">386</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="extended_features-387"><a href="#extended_features-387"><span class="linenos">387</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="extended_features-388"><a href="#extended_features-388"><span class="linenos">388</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="extended_features-389"><a href="#extended_features-389"><span class="linenos">389</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2"> - non-numeric or contains inf/NaN.&quot;</span><span class="p">)</span>
</span><span id="extended_features-390"><a href="#extended_features-390"><span class="linenos">390</span></a>                
</span><span id="extended_features-391"><a href="#extended_features-391"><span class="linenos">391</span></a>    
</span><span id="extended_features-392"><a href="#extended_features-392"><span class="linenos">392</span></a>    <span class="k">return</span> <span class="n">df1</span><span class="p">,</span> <span class="n">df2</span> 
</span></pre></div>


            <div class="docstring"><p>Extracts and extends feature sets from a list of Region of Interest (ROI)
images and returns two DataFrames containing scalar and array-based features 
respectively.</p>

<p>The function computes basic ROI features via <code><a href="#roi_features">roi_features()</a></code> and then 
performs additional morphological and shape analysis on each ROI, including 
thresholding (Otsu), morphological filtering, region labeling, and extraction 
of geometric and moment-based properties. </p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>rois</strong> (list of ndarray):
List of 2D NumPy arrays, each representing an ROI (grayscale image).</li>
<li><strong>df</strong> (pandas.DataFrame):
DataFrame containing metadata associated with each ROI, including a 
'Class' column that specifies the particle category or label.</li>
<li><strong>show</strong> (bool, optional (default=True)):
If True, displays boxplots of each numeric feature grouped by class. 
Skips features that are non-numeric or contain NaN/inf.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>df1</strong> (pandas.DataFrame):
DataFrame with original <code>df</code> columns, features from <code><a href="#roi_features">roi_features</a></code>, 
and additional scalar morphological features such as area, eccentricity, 
solidity, etc.</li>
<li><strong>df2</strong> (pandas.DataFrame):
DataFrame with original <code>df</code> columns and array-based features including 
image moments and central moments for each ROI.</li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>For ROIs that are empty or contain uniform values, NaNs are assigned to 
all extracted features.</li>
<li>Features extracted include:
<ul>
<li>Scalar: area, convex area, eccentricity, solidity, equivalent diameter, 
extent, number of pixels, orientation, and perimeter.</li>
<li>Array: raw spatial moments and central moments (both as 3x3 arrays).</li>
</ul></li>
<li>The function assumes that the <code>df</code> DataFrame has the same number of rows 
as the number of ROIs provided, and that it includes a 'Class' column for 
grouping.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>Handles all exceptions during individual ROI processing and prints an error</strong></li>
<li><strong>message.</strong></li>
</ul>
</div>


                </section>
                <section id="roi_features">
                            <input id="roi_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">roi_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">rois</span>, </span><span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">show</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">out</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="roi_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#roi_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="roi_features-395"><a href="#roi_features-395"><span class="linenos">395</span></a><span class="k">def</span> <span class="nf">roi_features</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="roi_features-396"><a href="#roi_features-396"><span class="linenos">396</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="roi_features-397"><a href="#roi_features-397"><span class="linenos">397</span></a><span class="sd">    Extracts intensity-based statistical features from a list of ROI images and </span>
</span><span id="roi_features-398"><a href="#roi_features-398"><span class="linenos">398</span></a><span class="sd">    optionally visualizes feature distributions across classes.</span>
</span><span id="roi_features-399"><a href="#roi_features-399"><span class="linenos">399</span></a><span class="sd">    </span>
</span><span id="roi_features-400"><a href="#roi_features-400"><span class="linenos">400</span></a><span class="sd">    This function computes various intensity statistics such as max, min, mean,</span>
</span><span id="roi_features-401"><a href="#roi_features-401"><span class="linenos">401</span></a><span class="sd">    median, standard deviation, variance, skewness, and kurtosis for each</span>
</span><span id="roi_features-402"><a href="#roi_features-402"><span class="linenos">402</span></a><span class="sd">    Region of Interest (ROI). It associates these features with the corresponding </span>
</span><span id="roi_features-403"><a href="#roi_features-403"><span class="linenos">403</span></a><span class="sd">    class labels from the input DataFrame.</span>
</span><span id="roi_features-404"><a href="#roi_features-404"><span class="linenos">404</span></a><span class="sd">    </span>
</span><span id="roi_features-405"><a href="#roi_features-405"><span class="linenos">405</span></a><span class="sd">    Parameters</span>
</span><span id="roi_features-406"><a href="#roi_features-406"><span class="linenos">406</span></a><span class="sd">    ----------</span>
</span><span id="roi_features-407"><a href="#roi_features-407"><span class="linenos">407</span></a><span class="sd">    rois : list of ndarray</span>
</span><span id="roi_features-408"><a href="#roi_features-408"><span class="linenos">408</span></a><span class="sd">        List of 2D NumPy arrays representing grayscale ROI images.</span>
</span><span id="roi_features-409"><a href="#roi_features-409"><span class="linenos">409</span></a><span class="sd">    </span>
</span><span id="roi_features-410"><a href="#roi_features-410"><span class="linenos">410</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="roi_features-411"><a href="#roi_features-411"><span class="linenos">411</span></a><span class="sd">        DataFrame containing metadata for each ROI. Must include a &#39;Class&#39; </span>
</span><span id="roi_features-412"><a href="#roi_features-412"><span class="linenos">412</span></a><span class="sd">        column specifying the category of each ROI.</span>
</span><span id="roi_features-413"><a href="#roi_features-413"><span class="linenos">413</span></a><span class="sd">    </span>
</span><span id="roi_features-414"><a href="#roi_features-414"><span class="linenos">414</span></a><span class="sd">    show : bool, optional (default=True)</span>
</span><span id="roi_features-415"><a href="#roi_features-415"><span class="linenos">415</span></a><span class="sd">        If True, generates boxplots of each feature grouped by class for visual </span>
</span><span id="roi_features-416"><a href="#roi_features-416"><span class="linenos">416</span></a><span class="sd">        comparison.</span>
</span><span id="roi_features-417"><a href="#roi_features-417"><span class="linenos">417</span></a><span class="sd">    </span>
</span><span id="roi_features-418"><a href="#roi_features-418"><span class="linenos">418</span></a><span class="sd">    out : int, optional (default=1)</span>
</span><span id="roi_features-419"><a href="#roi_features-419"><span class="linenos">419</span></a><span class="sd">        Determines the format of the output:</span>
</span><span id="roi_features-420"><a href="#roi_features-420"><span class="linenos">420</span></a><span class="sd">        - If 0: returns a new DataFrame containing only the computed features </span>
</span><span id="roi_features-421"><a href="#roi_features-421"><span class="linenos">421</span></a><span class="sd">                and class labels.</span>
</span><span id="roi_features-422"><a href="#roi_features-422"><span class="linenos">422</span></a><span class="sd">        - If 1: appends the computed features to the original DataFrame and </span>
</span><span id="roi_features-423"><a href="#roi_features-423"><span class="linenos">423</span></a><span class="sd">                returns the result.</span>
</span><span id="roi_features-424"><a href="#roi_features-424"><span class="linenos">424</span></a><span class="sd">    </span>
</span><span id="roi_features-425"><a href="#roi_features-425"><span class="linenos">425</span></a><span class="sd">    Returns</span>
</span><span id="roi_features-426"><a href="#roi_features-426"><span class="linenos">426</span></a><span class="sd">    -------</span>
</span><span id="roi_features-427"><a href="#roi_features-427"><span class="linenos">427</span></a><span class="sd">    pandas.DataFrame</span>
</span><span id="roi_features-428"><a href="#roi_features-428"><span class="linenos">428</span></a><span class="sd">        Depending on `out`:</span>
</span><span id="roi_features-429"><a href="#roi_features-429"><span class="linenos">429</span></a><span class="sd">        - If out == 0: returns a new DataFrame with computed features and </span>
</span><span id="roi_features-430"><a href="#roi_features-430"><span class="linenos">430</span></a><span class="sd">                       &#39;class&#39; column.</span>
</span><span id="roi_features-431"><a href="#roi_features-431"><span class="linenos">431</span></a><span class="sd">        - If out == 1: returns the original DataFrame with added columns for </span>
</span><span id="roi_features-432"><a href="#roi_features-432"><span class="linenos">432</span></a><span class="sd">                        each computed feature.</span>
</span><span id="roi_features-433"><a href="#roi_features-433"><span class="linenos">433</span></a><span class="sd">    </span>
</span><span id="roi_features-434"><a href="#roi_features-434"><span class="linenos">434</span></a><span class="sd">    Notes</span>
</span><span id="roi_features-435"><a href="#roi_features-435"><span class="linenos">435</span></a><span class="sd">    -----</span>
</span><span id="roi_features-436"><a href="#roi_features-436"><span class="linenos">436</span></a><span class="sd">    - For empty ROIs, NaN is assigned to all computed features.</span>
</span><span id="roi_features-437"><a href="#roi_features-437"><span class="linenos">437</span></a><span class="sd">    - The &#39;Class&#39; column is extracted from `df.Class` and is expected to be </span>
</span><span id="roi_features-438"><a href="#roi_features-438"><span class="linenos">438</span></a><span class="sd">      convertible to scalar.</span>
</span><span id="roi_features-439"><a href="#roi_features-439"><span class="linenos">439</span></a><span class="sd">    </span>
</span><span id="roi_features-440"><a href="#roi_features-440"><span class="linenos">440</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="roi_features-441"><a href="#roi_features-441"><span class="linenos">441</span></a>
</span><span id="roi_features-442"><a href="#roi_features-442"><span class="linenos">442</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="roi_features-443"><a href="#roi_features-443"><span class="linenos">443</span></a>        <span class="c1"># Maximum intensity</span>
</span><span id="roi_features-444"><a href="#roi_features-444"><span class="linenos">444</span></a>        <span class="s1">&#39;max&#39;</span>   <span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="roi_features-445"><a href="#roi_features-445"><span class="linenos">445</span></a>        <span class="c1"># Minimum intensity</span>
</span><span id="roi_features-446"><a href="#roi_features-446"><span class="linenos">446</span></a>        <span class="s1">&#39;min&#39;</span>   <span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="roi_features-447"><a href="#roi_features-447"><span class="linenos">447</span></a>        <span class="c1"># Mean intensity</span>
</span><span id="roi_features-448"><a href="#roi_features-448"><span class="linenos">448</span></a>        <span class="s1">&#39;mean&#39;</span>  <span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="roi_features-449"><a href="#roi_features-449"><span class="linenos">449</span></a>        <span class="c1"># Median intensity</span>
</span><span id="roi_features-450"><a href="#roi_features-450"><span class="linenos">450</span></a>        <span class="s1">&#39;median&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="roi_features-451"><a href="#roi_features-451"><span class="linenos">451</span></a>        <span class="c1"># Standard deviation</span>
</span><span id="roi_features-452"><a href="#roi_features-452"><span class="linenos">452</span></a>        <span class="s1">&#39;stdev&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="roi_features-453"><a href="#roi_features-453"><span class="linenos">453</span></a>        <span class="c1"># Variance</span>
</span><span id="roi_features-454"><a href="#roi_features-454"><span class="linenos">454</span></a>        <span class="s1">&#39;var&#39;</span>   <span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span> <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="roi_features-455"><a href="#roi_features-455"><span class="linenos">455</span></a>        <span class="c1"># Skewness (asymmetry of pixel intensity)</span>
</span><span id="roi_features-456"><a href="#roi_features-456"><span class="linenos">456</span></a>        <span class="s1">&#39;skew&#39;</span>  <span class="p">:</span> <span class="p">[</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> \
</span><span id="roi_features-457"><a href="#roi_features-457"><span class="linenos">457</span></a>                   <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="roi_features-458"><a href="#roi_features-458"><span class="linenos">458</span></a>        <span class="c1"># Kurtosis (peakedness of intensity distribution)</span>
</span><span id="roi_features-459"><a href="#roi_features-459"><span class="linenos">459</span></a>        <span class="s1">&#39;kurt&#39;</span>  <span class="p">:</span> <span class="p">[</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> \
</span><span id="roi_features-460"><a href="#roi_features-460"><span class="linenos">460</span></a>                   <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">],</span>
</span><span id="roi_features-461"><a href="#roi_features-461"><span class="linenos">461</span></a>        <span class="c1"># True Class</span>
</span><span id="roi_features-462"><a href="#roi_features-462"><span class="linenos">462</span></a>        <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">Class</span><span class="p">]</span>
</span><span id="roi_features-463"><a href="#roi_features-463"><span class="linenos">463</span></a>    <span class="p">}</span>
</span><span id="roi_features-464"><a href="#roi_features-464"><span class="linenos">464</span></a>    
</span><span id="roi_features-465"><a href="#roi_features-465"><span class="linenos">465</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="roi_features-466"><a href="#roi_features-466"><span class="linenos">466</span></a>    
</span><span id="roi_features-467"><a href="#roi_features-467"><span class="linenos">467</span></a>    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
</span><span id="roi_features-468"><a href="#roi_features-468"><span class="linenos">468</span></a>        <span class="c1"># Omit the last key (assumed to be &#39;class&#39;)</span>
</span><span id="roi_features-469"><a href="#roi_features-469"><span class="linenos">469</span></a>        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  
</span><span id="roi_features-470"><a href="#roi_features-470"><span class="linenos">470</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="roi_features-471"><a href="#roi_features-471"><span class="linenos">471</span></a>                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">)</span>
</span><span id="roi_features-472"><a href="#roi_features-472"><span class="linenos">472</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution of </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1"> across classes&#39;</span><span class="p">)</span>
</span><span id="roi_features-473"><a href="#roi_features-473"><span class="linenos">473</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Class&#39;</span><span class="p">)</span>
</span><span id="roi_features-474"><a href="#roi_features-474"><span class="linenos">474</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
</span><span id="roi_features-475"><a href="#roi_features-475"><span class="linenos">475</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="roi_features-476"><a href="#roi_features-476"><span class="linenos">476</span></a>                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="roi_features-477"><a href="#roi_features-477"><span class="linenos">477</span></a>                
</span><span id="roi_features-478"><a href="#roi_features-478"><span class="linenos">478</span></a>
</span><span id="roi_features-479"><a href="#roi_features-479"><span class="linenos">479</span></a>    
</span><span id="roi_features-480"><a href="#roi_features-480"><span class="linenos">480</span></a>    <span class="k">if</span> <span class="n">out</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> 
</span><span id="roi_features-481"><a href="#roi_features-481"><span class="linenos">481</span></a>        <span class="c1"># return new attributes</span>
</span><span id="roi_features-482"><a href="#roi_features-482"><span class="linenos">482</span></a>        <span class="k">return</span> <span class="n">data</span>
</span><span id="roi_features-483"><a href="#roi_features-483"><span class="linenos">483</span></a>    
</span><span id="roi_features-484"><a href="#roi_features-484"><span class="linenos">484</span></a>    <span class="k">elif</span> <span class="n">out</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
</span><span id="roi_features-485"><a href="#roi_features-485"><span class="linenos">485</span></a>        <span class="c1"># return all attributes</span>
</span><span id="roi_features-486"><a href="#roi_features-486"><span class="linenos">486</span></a>        <span class="c1"># Drop duplicate &#39;class&#39; column to avoid conflicts</span>
</span><span id="roi_features-487"><a href="#roi_features-487"><span class="linenos">487</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">])</span>
</span><span id="roi_features-488"><a href="#roi_features-488"><span class="linenos">488</span></a>
</span><span id="roi_features-489"><a href="#roi_features-489"><span class="linenos">489</span></a>        <span class="c1"># Append the features to the original df</span>
</span><span id="roi_features-490"><a href="#roi_features-490"><span class="linenos">490</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> 
</span><span id="roi_features-491"><a href="#roi_features-491"><span class="linenos">491</span></a>                        <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> 
</span><span id="roi_features-492"><a href="#roi_features-492"><span class="linenos">492</span></a>                       <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="roi_features-493"><a href="#roi_features-493"><span class="linenos">493</span></a>        <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Extracts intensity-based statistical features from a list of ROI images and 
optionally visualizes feature distributions across classes.</p>

<p>This function computes various intensity statistics such as max, min, mean,
median, standard deviation, variance, skewness, and kurtosis for each
Region of Interest (ROI). It associates these features with the corresponding 
class labels from the input DataFrame.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>rois</strong> (list of ndarray):
List of 2D NumPy arrays representing grayscale ROI images.</li>
<li><strong>df</strong> (pandas.DataFrame):
DataFrame containing metadata for each ROI. Must include a 'Class' 
column specifying the category of each ROI.</li>
<li><strong>show</strong> (bool, optional (default=True)):
If True, generates boxplots of each feature grouped by class for visual 
comparison.</li>
<li><strong>out</strong> (int, optional (default=1)):
Determines the format of the output:
<ul>
<li>If 0: returns a new DataFrame containing only the computed features 
and class labels.</li>
<li>If 1: appends the computed features to the original DataFrame and 
returns the result.</li>
</ul></li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>pandas.DataFrame</strong>: Depending on <code>out</code>:
<ul>
<li>If out == 0: returns a new DataFrame with computed features and 
'class' column.</li>
<li>If out == 1: returns the original DataFrame with added columns for 
each computed feature.</li>
</ul></li>
</ul>

<h6 id="notes">Notes</h6>

<ul>
<li>For empty ROIs, NaN is assigned to all computed features.</li>
<li>The 'Class' column is extracted from <code>df.Class</code> and is expected to be 
convertible to scalar.</li>
</ul>
</div>


                </section>
                <section id="corr_features">
                            <input id="corr_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">corr_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">rois</span>, </span><span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">masks</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="corr_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#corr_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="corr_features-496"><a href="#corr_features-496"><span class="linenos">496</span></a><span class="k">def</span> <span class="nf">corr_features</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">masks</span><span class="p">):</span>
</span><span id="corr_features-497"><a href="#corr_features-497"><span class="linenos">497</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="corr_features-498"><a href="#corr_features-498"><span class="linenos">498</span></a><span class="sd">    Calculates image-based correlation (normalized cross-correlation)</span>
</span><span id="corr_features-499"><a href="#corr_features-499"><span class="linenos">499</span></a><span class="sd">    between each ROI and each class-average mask using template matching.</span>
</span><span id="corr_features-500"><a href="#corr_features-500"><span class="linenos">500</span></a>
</span><span id="corr_features-501"><a href="#corr_features-501"><span class="linenos">501</span></a><span class="sd">    Parameters:</span>
</span><span id="corr_features-502"><a href="#corr_features-502"><span class="linenos">502</span></a><span class="sd">    -----------</span>
</span><span id="corr_features-503"><a href="#corr_features-503"><span class="linenos">503</span></a><span class="sd">    rois : list of np.ndarray</span>
</span><span id="corr_features-504"><a href="#corr_features-504"><span class="linenos">504</span></a><span class="sd">        List of 2D ROI images (grayscale). Each ROI should be of the same shape </span>
</span><span id="corr_features-505"><a href="#corr_features-505"><span class="linenos">505</span></a><span class="sd">        as the corresponding masks for valid correlation computation.</span>
</span><span id="corr_features-506"><a href="#corr_features-506"><span class="linenos">506</span></a>
</span><span id="corr_features-507"><a href="#corr_features-507"><span class="linenos">507</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="corr_features-508"><a href="#corr_features-508"><span class="linenos">508</span></a><span class="sd">        DataFrame with one row per ROI. It must have at least the same length </span>
</span><span id="corr_features-509"><a href="#corr_features-509"><span class="linenos">509</span></a><span class="sd">        as `rois`. Expected to include a &#39;Class&#39; column, although it&#39;s not used </span>
</span><span id="corr_features-510"><a href="#corr_features-510"><span class="linenos">510</span></a><span class="sd">        directly in this function.</span>
</span><span id="corr_features-511"><a href="#corr_features-511"><span class="linenos">511</span></a>
</span><span id="corr_features-512"><a href="#corr_features-512"><span class="linenos">512</span></a><span class="sd">    masks : dict or list of np.ndarray</span>
</span><span id="corr_features-513"><a href="#corr_features-513"><span class="linenos">513</span></a><span class="sd">        Class-average masks for template matching. Can be:</span>
</span><span id="corr_features-514"><a href="#corr_features-514"><span class="linenos">514</span></a><span class="sd">            - A dictionary with keys like &#39;CorrCL1&#39;, &#39;CorrCL2&#39;, ..., &#39;CorrCL4&#39;.</span>
</span><span id="corr_features-515"><a href="#corr_features-515"><span class="linenos">515</span></a><span class="sd">            - A list of four masks (assumed ordered by class index 1 to 4).</span>
</span><span id="corr_features-516"><a href="#corr_features-516"><span class="linenos">516</span></a>
</span><span id="corr_features-517"><a href="#corr_features-517"><span class="linenos">517</span></a><span class="sd">    Returns:</span>
</span><span id="corr_features-518"><a href="#corr_features-518"><span class="linenos">518</span></a><span class="sd">    --------</span>
</span><span id="corr_features-519"><a href="#corr_features-519"><span class="linenos">519</span></a><span class="sd">    pd.DataFrame</span>
</span><span id="corr_features-520"><a href="#corr_features-520"><span class="linenos">520</span></a><span class="sd">        DataFrame of shape (n_rois, 5), with:</span>
</span><span id="corr_features-521"><a href="#corr_features-521"><span class="linenos">521</span></a><span class="sd">            - One column per class: correlation scores </span>
</span><span id="corr_features-522"><a href="#corr_features-522"><span class="linenos">522</span></a><span class="sd">            - A &#39;bestMatch&#39; column: integer from 1 to 4, indicating the class </span>
</span><span id="corr_features-523"><a href="#corr_features-523"><span class="linenos">523</span></a><span class="sd">                                    with max correlation.</span>
</span><span id="corr_features-524"><a href="#corr_features-524"><span class="linenos">524</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="corr_features-525"><a href="#corr_features-525"><span class="linenos">525</span></a>
</span><span id="corr_features-526"><a href="#corr_features-526"><span class="linenos">526</span></a>    <span class="c1"># Convert list of masks to a dict with predefined class labels if needed</span>
</span><span id="corr_features-527"><a href="#corr_features-527"><span class="linenos">527</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="corr_features-528"><a href="#corr_features-528"><span class="linenos">528</span></a>        <span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CorrCL1&quot;</span><span class="p">,</span> <span class="s2">&quot;CorrCL2&quot;</span><span class="p">,</span> <span class="s2">&quot;CorrCL3&quot;</span><span class="p">,</span> <span class="s2">&quot;CorrCL4&quot;</span><span class="p">]</span>
</span><span id="corr_features-529"><a href="#corr_features-529"><span class="linenos">529</span></a>        <span class="n">mask_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">class_names</span><span class="p">,</span> <span class="n">masks</span><span class="p">)}</span>
</span><span id="corr_features-530"><a href="#corr_features-530"><span class="linenos">530</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="corr_features-531"><a href="#corr_features-531"><span class="linenos">531</span></a>        <span class="n">mask_dict</span> <span class="o">=</span> <span class="n">masks</span>
</span><span id="corr_features-532"><a href="#corr_features-532"><span class="linenos">532</span></a>        <span class="n">class_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mask_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="corr_features-533"><a href="#corr_features-533"><span class="linenos">533</span></a>
</span><span id="corr_features-534"><a href="#corr_features-534"><span class="linenos">534</span></a>    <span class="c1"># Will hold correlation scores per ROI</span>
</span><span id="corr_features-535"><a href="#corr_features-535"><span class="linenos">535</span></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>  
</span><span id="corr_features-536"><a href="#corr_features-536"><span class="linenos">536</span></a>
</span><span id="corr_features-537"><a href="#corr_features-537"><span class="linenos">537</span></a>    <span class="c1"># Loop over each ROI image</span>
</span><span id="corr_features-538"><a href="#corr_features-538"><span class="linenos">538</span></a>    <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">rois</span><span class="p">:</span>
</span><span id="corr_features-539"><a href="#corr_features-539"><span class="linenos">539</span></a>        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="corr_features-540"><a href="#corr_features-540"><span class="linenos">540</span></a>        
</span><span id="corr_features-541"><a href="#corr_features-541"><span class="linenos">541</span></a>        <span class="c1"># Loop over each class mask and compute normalized cross-correlation</span>
</span><span id="corr_features-542"><a href="#corr_features-542"><span class="linenos">542</span></a>        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">class_names</span><span class="p">:</span>
</span><span id="corr_features-543"><a href="#corr_features-543"><span class="linenos">543</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_dict</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span>
</span><span id="corr_features-544"><a href="#corr_features-544"><span class="linenos">544</span></a>            
</span><span id="corr_features-545"><a href="#corr_features-545"><span class="linenos">545</span></a>            <span class="c1"># Check shape compatibility</span>
</span><span id="corr_features-546"><a href="#corr_features-546"><span class="linenos">546</span></a>            <span class="k">if</span> <span class="n">roi</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="corr_features-547"><a href="#corr_features-547"><span class="linenos">547</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ROI and mask shapes must match.&quot;</span><span class="p">)</span>
</span><span id="corr_features-548"><a href="#corr_features-548"><span class="linenos">548</span></a>
</span><span id="corr_features-549"><a href="#corr_features-549"><span class="linenos">549</span></a>            <span class="c1"># Compute normalized cross-correlation using match_template</span>
</span><span id="corr_features-550"><a href="#corr_features-550"><span class="linenos">550</span></a>            <span class="c1"># Since the ROI and mask are same-sized, the result is a single value</span>
</span><span id="corr_features-551"><a href="#corr_features-551"><span class="linenos">551</span></a>            <span class="n">ncc_score</span> <span class="o">=</span> <span class="n">match_template</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pad_input</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="corr_features-552"><a href="#corr_features-552"><span class="linenos">552</span></a>            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ncc_score</span><span class="p">)</span>
</span><span id="corr_features-553"><a href="#corr_features-553"><span class="linenos">553</span></a>        
</span><span id="corr_features-554"><a href="#corr_features-554"><span class="linenos">554</span></a>        <span class="c1"># Save results</span>
</span><span id="corr_features-555"><a href="#corr_features-555"><span class="linenos">555</span></a>        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span><span id="corr_features-556"><a href="#corr_features-556"><span class="linenos">556</span></a>
</span><span id="corr_features-557"><a href="#corr_features-557"><span class="linenos">557</span></a>    <span class="c1"># Create a DataFrame from the correlation scores</span>
</span><span id="corr_features-558"><a href="#corr_features-558"><span class="linenos">558</span></a>    <span class="n">corr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ccorr</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">class_names</span><span class="p">])</span>
</span><span id="corr_features-559"><a href="#corr_features-559"><span class="linenos">559</span></a>
</span><span id="corr_features-560"><a href="#corr_features-560"><span class="linenos">560</span></a>    <span class="c1"># Identify the highest correlation score and corresponding class index</span>
</span><span id="corr_features-561"><a href="#corr_features-561"><span class="linenos">561</span></a>    <span class="n">corr_df</span><span class="p">[</span><span class="s2">&quot;maxCorr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="corr_features-562"><a href="#corr_features-562"><span class="linenos">562</span></a>    
</span><span id="corr_features-563"><a href="#corr_features-563"><span class="linenos">563</span></a>    <span class="c1"># Find which column had the max</span>
</span><span id="corr_features-564"><a href="#corr_features-564"><span class="linenos">564</span></a>    <span class="n">corr_df</span><span class="p">[</span><span class="s2">&quot;bestMatch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  
</span><span id="corr_features-565"><a href="#corr_features-565"><span class="linenos">565</span></a>
</span><span id="corr_features-566"><a href="#corr_features-566"><span class="linenos">566</span></a>    <span class="c1"># Extract the class number from the column name, e.g., &#39;ccorrCorrCL2&#39; → 2</span>
</span><span id="corr_features-567"><a href="#corr_features-567"><span class="linenos">567</span></a>    <span class="n">corr_df</span><span class="p">[</span><span class="s2">&quot;bestMatch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_df</span><span class="p">[</span><span class="s2">&quot;bestMatch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d)$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="corr_features-568"><a href="#corr_features-568"><span class="linenos">568</span></a>
</span><span id="corr_features-569"><a href="#corr_features-569"><span class="linenos">569</span></a>    <span class="c1"># Drop intermediate maxCorr column (optional)</span>
</span><span id="corr_features-570"><a href="#corr_features-570"><span class="linenos">570</span></a>    <span class="n">corr_df</span> <span class="o">=</span> <span class="n">corr_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;maxCorr&quot;</span><span class="p">])</span>
</span><span id="corr_features-571"><a href="#corr_features-571"><span class="linenos">571</span></a>
</span><span id="corr_features-572"><a href="#corr_features-572"><span class="linenos">572</span></a>    <span class="k">return</span> <span class="n">corr_df</span>
</span></pre></div>


            <div class="docstring"><p>Calculates image-based correlation (normalized cross-correlation)
between each ROI and each class-average mask using template matching.</p>

<h2 id="parameters">Parameters:</h2>

<p>rois : list of np.ndarray
    List of 2D ROI images (grayscale). Each ROI should be of the same shape 
    as the corresponding masks for valid correlation computation.</p>

<p>df : pandas.DataFrame
    DataFrame with one row per ROI. It must have at least the same length 
    as <code>rois</code>. Expected to include a 'Class' column, although it's not used 
    directly in this function.</p>

<p>masks : dict or list of np.ndarray
    Class-average masks for template matching. Can be:
        - A dictionary with keys like 'CorrCL1', 'CorrCL2', ..., 'CorrCL4'.
        - A list of four masks (assumed ordered by class index 1 to 4).</p>

<h2 id="returns">Returns:</h2>

<p>pd.DataFrame
    DataFrame of shape (n_rois, 5), with:
        - One column per class: correlation scores 
        - A 'bestMatch' column: integer from 1 to 4, indicating the class 
                                with max correlation.</p>
</div>


                </section>
                <section id="gauss_features">
                            <input id="gauss_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gauss_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df_params</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="gauss_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#gauss_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="gauss_features-575"><a href="#gauss_features-575"><span class="linenos">575</span></a><span class="k">def</span> <span class="nf">gauss_features</span><span class="p">(</span><span class="n">df_params</span><span class="p">):</span>
</span><span id="gauss_features-576"><a href="#gauss_features-576"><span class="linenos">576</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="gauss_features-577"><a href="#gauss_features-577"><span class="linenos">577</span></a><span class="sd">    Computes derived features from 2D Gaussian parameters.</span>
</span><span id="gauss_features-578"><a href="#gauss_features-578"><span class="linenos">578</span></a>
</span><span id="gauss_features-579"><a href="#gauss_features-579"><span class="linenos">579</span></a><span class="sd">    Parameters</span>
</span><span id="gauss_features-580"><a href="#gauss_features-580"><span class="linenos">580</span></a><span class="sd">    ----------</span>
</span><span id="gauss_features-581"><a href="#gauss_features-581"><span class="linenos">581</span></a><span class="sd">    df_params : pandas.DataFrame</span>
</span><span id="gauss_features-582"><a href="#gauss_features-582"><span class="linenos">582</span></a><span class="sd">        A DataFrame with columns: [&#39;class&#39;, &#39;amplitude&#39;, &#39;sigma_x&#39;, &#39;sigma_y&#39;, </span>
</span><span id="gauss_features-583"><a href="#gauss_features-583"><span class="linenos">583</span></a><span class="sd">         &#39;theta&#39;, &#39;offset&#39;]</span>
</span><span id="gauss_features-584"><a href="#gauss_features-584"><span class="linenos">584</span></a>
</span><span id="gauss_features-585"><a href="#gauss_features-585"><span class="linenos">585</span></a><span class="sd">    Returns</span>
</span><span id="gauss_features-586"><a href="#gauss_features-586"><span class="linenos">586</span></a><span class="sd">    -------</span>
</span><span id="gauss_features-587"><a href="#gauss_features-587"><span class="linenos">587</span></a><span class="sd">    df_features : pandas.DataFrame</span>
</span><span id="gauss_features-588"><a href="#gauss_features-588"><span class="linenos">588</span></a><span class="sd">        The input DataFrame with additional derived features: fwhm_x, fwhm_y, </span>
</span><span id="gauss_features-589"><a href="#gauss_features-589"><span class="linenos">589</span></a><span class="sd">        area, eccentricity, ellipticity, orientation_deg, peak_intensity, </span>
</span><span id="gauss_features-590"><a href="#gauss_features-590"><span class="linenos">590</span></a><span class="sd">        contrast, integrated_intensity</span>
</span><span id="gauss_features-591"><a href="#gauss_features-591"><span class="linenos">591</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="gauss_features-592"><a href="#gauss_features-592"><span class="linenos">592</span></a>    <span class="c1"># Create a copy of the input dataframe to avoid modifying the original one</span>
</span><span id="gauss_features-593"><a href="#gauss_features-593"><span class="linenos">593</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="gauss_features-594"><a href="#gauss_features-594"><span class="linenos">594</span></a>
</span><span id="gauss_features-595"><a href="#gauss_features-595"><span class="linenos">595</span></a>    <span class="c1"># Constants</span>
</span><span id="gauss_features-596"><a href="#gauss_features-596"><span class="linenos">596</span></a>    <span class="c1"># (a) The factor for calculating FWHM from sigma (standard deviation)</span>
</span><span id="gauss_features-597"><a href="#gauss_features-597"><span class="linenos">597</span></a>    <span class="n">FWHM_factor</span> <span class="o">=</span> <span class="mf">2.355</span>
</span><span id="gauss_features-598"><a href="#gauss_features-598"><span class="linenos">598</span></a>    
</span><span id="gauss_features-599"><a href="#gauss_features-599"><span class="linenos">599</span></a>    <span class="c1"># (b) Pi constant for area and other calculations</span>
</span><span id="gauss_features-600"><a href="#gauss_features-600"><span class="linenos">600</span></a>    <span class="n">pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="gauss_features-601"><a href="#gauss_features-601"><span class="linenos">601</span></a>
</span><span id="gauss_features-602"><a href="#gauss_features-602"><span class="linenos">602</span></a>    <span class="c1"># Derived features based on Gaussian parameters</span>
</span><span id="gauss_features-603"><a href="#gauss_features-603"><span class="linenos">603</span></a>    <span class="c1"># (1) Full width at half maximum (FWHM) along x and y axes</span>
</span><span id="gauss_features-604"><a href="#gauss_features-604"><span class="linenos">604</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fwhm_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FWHM_factor</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">]</span>
</span><span id="gauss_features-605"><a href="#gauss_features-605"><span class="linenos">605</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fwhm_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FWHM_factor</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">]</span>
</span><span id="gauss_features-606"><a href="#gauss_features-606"><span class="linenos">606</span></a>    
</span><span id="gauss_features-607"><a href="#gauss_features-607"><span class="linenos">607</span></a>    <span class="c1"># (2) Area of the Gaussian shape (in terms of the standard deviations)</span>
</span><span id="gauss_features-608"><a href="#gauss_features-608"><span class="linenos">608</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;area2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">]</span>
</span><span id="gauss_features-609"><a href="#gauss_features-609"><span class="linenos">609</span></a>    
</span><span id="gauss_features-610"><a href="#gauss_features-610"><span class="linenos">610</span></a>    <span class="c1"># (3) Eccentricity (how elongated the shape is, 0 = circular, 1 = linear)</span>
</span><span id="gauss_features-611"><a href="#gauss_features-611"><span class="linenos">611</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eccentricity2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">],</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span> 
</span><span id="gauss_features-612"><a href="#gauss_features-612"><span class="linenos">612</span></a>                                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="gauss_features-613"><a href="#gauss_features-613"><span class="linenos">613</span></a>    
</span><span id="gauss_features-614"><a href="#gauss_features-614"><span class="linenos">614</span></a>    <span class="c1"># (4) Ellipticity (ratio of sigma_x to sigma_y)</span>
</span><span id="gauss_features-615"><a href="#gauss_features-615"><span class="linenos">615</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ellipticity2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">]</span>
</span><span id="gauss_features-616"><a href="#gauss_features-616"><span class="linenos">616</span></a>    
</span><span id="gauss_features-617"><a href="#gauss_features-617"><span class="linenos">617</span></a>    <span class="c1"># (5) Orientation (the angle of rotation of the Gaussian in radians, </span>
</span><span id="gauss_features-618"><a href="#gauss_features-618"><span class="linenos">618</span></a>    <span class="c1">#     converted to degrees)</span>
</span><span id="gauss_features-619"><a href="#gauss_features-619"><span class="linenos">619</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;orientation_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">])</span>
</span><span id="gauss_features-620"><a href="#gauss_features-620"><span class="linenos">620</span></a>    
</span><span id="gauss_features-621"><a href="#gauss_features-621"><span class="linenos">621</span></a>    <span class="c1"># (6) Peak intensity (the intensity at the peak of the Gaussian)</span>
</span><span id="gauss_features-622"><a href="#gauss_features-622"><span class="linenos">622</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peak_intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span>
</span><span id="gauss_features-623"><a href="#gauss_features-623"><span class="linenos">623</span></a>    
</span><span id="gauss_features-624"><a href="#gauss_features-624"><span class="linenos">624</span></a>    <span class="c1"># (7) Contrast (normalized contrast of the peak)</span>
</span><span id="gauss_features-625"><a href="#gauss_features-625"><span class="linenos">625</span></a>    <span class="c1">#     A small epsilon is added to avoid division by zero for cases where </span>
</span><span id="gauss_features-626"><a href="#gauss_features-626"><span class="linenos">626</span></a>    <span class="c1">#     amplitude + offset is too small</span>
</span><span id="gauss_features-627"><a href="#gauss_features-627"><span class="linenos">627</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;contrast2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>  
</span><span id="gauss_features-628"><a href="#gauss_features-628"><span class="linenos">628</span></a>    
</span><span id="gauss_features-629"><a href="#gauss_features-629"><span class="linenos">629</span></a>    <span class="c1"># (8) Integrated intensity (total intensity under the Gaussian, related to</span>
</span><span id="gauss_features-630"><a href="#gauss_features-630"><span class="linenos">630</span></a>    <span class="c1">#     its area)</span>
</span><span id="gauss_features-631"><a href="#gauss_features-631"><span class="linenos">631</span></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;integrated_intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">]</span>
</span><span id="gauss_features-632"><a href="#gauss_features-632"><span class="linenos">632</span></a>    
</span><span id="gauss_features-633"><a href="#gauss_features-633"><span class="linenos">633</span></a>    <span class="c1"># Drop the &#39;x0&#39; and &#39;y0&#39; columns </span>
</span><span id="gauss_features-634"><a href="#gauss_features-634"><span class="linenos">634</span></a>    <span class="c1"># errors=&#39;ignore&#39; to handle if &#39;x0&#39; or &#39;y0&#39; is missing</span>
</span><span id="gauss_features-635"><a href="#gauss_features-635"><span class="linenos">635</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span>
</span><span id="gauss_features-636"><a href="#gauss_features-636"><span class="linenos">636</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span>
</span><span id="gauss_features-637"><a href="#gauss_features-637"><span class="linenos">637</span></a>
</span><span id="gauss_features-638"><a href="#gauss_features-638"><span class="linenos">638</span></a>
</span><span id="gauss_features-639"><a href="#gauss_features-639"><span class="linenos">639</span></a>    <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Computes derived features from 2D Gaussian parameters.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>df_params</strong> (pandas.DataFrame):
A DataFrame with columns: ['class', 'amplitude', 'sigma_x', 'sigma_y', 
 'theta', 'offset']</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>df_features</strong> (pandas.DataFrame):
The input DataFrame with additional derived features: fwhm_x, fwhm_y, 
area, eccentricity, ellipticity, orientation_deg, peak_intensity, 
contrast, integrated_intensity</li>
</ul>
</div>


                </section>
                <section id="gauss_params">
                            <input id="gauss_params-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gauss_params</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">image_list</span>, </span><span class="param"><span class="n">df</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="gauss_params-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#gauss_params"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="gauss_params-642"><a href="#gauss_params-642"><span class="linenos">642</span></a><span class="k">def</span> <span class="nf">gauss_params</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
</span><span id="gauss_params-643"><a href="#gauss_params-643"><span class="linenos">643</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="gauss_params-644"><a href="#gauss_params-644"><span class="linenos">644</span></a><span class="sd">    Fits a 2D Gaussian function to each image (ROI) in the given list and </span>
</span><span id="gauss_params-645"><a href="#gauss_params-645"><span class="linenos">645</span></a><span class="sd">    returns the estimated parameters for each fit in a DataFrame.</span>
</span><span id="gauss_params-646"><a href="#gauss_params-646"><span class="linenos">646</span></a>
</span><span id="gauss_params-647"><a href="#gauss_params-647"><span class="linenos">647</span></a><span class="sd">    Parameters</span>
</span><span id="gauss_params-648"><a href="#gauss_params-648"><span class="linenos">648</span></a><span class="sd">    ----------</span>
</span><span id="gauss_params-649"><a href="#gauss_params-649"><span class="linenos">649</span></a><span class="sd">    image_list : list of np.ndarray</span>
</span><span id="gauss_params-650"><a href="#gauss_params-650"><span class="linenos">650</span></a><span class="sd">        A list of 2D NumPy arrays representing grayscale image regions (ROIs) </span>
</span><span id="gauss_params-651"><a href="#gauss_params-651"><span class="linenos">651</span></a><span class="sd">        where a Gaussian-like spot is expected.</span>
</span><span id="gauss_params-652"><a href="#gauss_params-652"><span class="linenos">652</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="gauss_params-653"><a href="#gauss_params-653"><span class="linenos">653</span></a><span class="sd">        DataFrame containing metadata for each ROI, including a &#39;Class&#39; column </span>
</span><span id="gauss_params-654"><a href="#gauss_params-654"><span class="linenos">654</span></a><span class="sd">        that assigns a label to each image.</span>
</span><span id="gauss_params-655"><a href="#gauss_params-655"><span class="linenos">655</span></a>
</span><span id="gauss_params-656"><a href="#gauss_params-656"><span class="linenos">656</span></a><span class="sd">    Returns</span>
</span><span id="gauss_params-657"><a href="#gauss_params-657"><span class="linenos">657</span></a><span class="sd">    -------</span>
</span><span id="gauss_params-658"><a href="#gauss_params-658"><span class="linenos">658</span></a><span class="sd">    df_params : pandas.DataFrame</span>
</span><span id="gauss_params-659"><a href="#gauss_params-659"><span class="linenos">659</span></a><span class="sd">        A DataFrame where each row corresponds to the parameters </span>
</span><span id="gauss_params-660"><a href="#gauss_params-660"><span class="linenos">660</span></a><span class="sd">        of a 2D Gaussian fit for an image in `image_list`. If a fit fails, </span>
</span><span id="gauss_params-661"><a href="#gauss_params-661"><span class="linenos">661</span></a><span class="sd">        the row contains NaNs.</span>
</span><span id="gauss_params-662"><a href="#gauss_params-662"><span class="linenos">662</span></a>
</span><span id="gauss_params-663"><a href="#gauss_params-663"><span class="linenos">663</span></a><span class="sd">        Columns: class (label of the ROI), amplitude (peak height of the Gauss),</span>
</span><span id="gauss_params-664"><a href="#gauss_params-664"><span class="linenos">664</span></a><span class="sd">                 x0, y0 (center coordinates), sigma_x (std deviation in x dir.),</span>
</span><span id="gauss_params-665"><a href="#gauss_params-665"><span class="linenos">665</span></a><span class="sd">                 sigma_y  (std deviation in y direction), theta (rotation angle </span>
</span><span id="gauss_params-666"><a href="#gauss_params-666"><span class="linenos">666</span></a><span class="sd">                 of the Gaussian ellipse), offset (constant background level)</span>
</span><span id="gauss_params-667"><a href="#gauss_params-667"><span class="linenos">667</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="gauss_params-668"><a href="#gauss_params-668"><span class="linenos">668</span></a>    <span class="c1"># Initialize variables</span>
</span><span id="gauss_params-669"><a href="#gauss_params-669"><span class="linenos">669</span></a>    <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">,</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">,</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">,</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">,</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> 
</span><span id="gauss_params-670"><a href="#gauss_params-670"><span class="linenos">670</span></a>                   <span class="s1">&#39;offset&#39;</span><span class="p">]</span>
</span><span id="gauss_params-671"><a href="#gauss_params-671"><span class="linenos">671</span></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="gauss_params-672"><a href="#gauss_params-672"><span class="linenos">672</span></a>
</span><span id="gauss_params-673"><a href="#gauss_params-673"><span class="linenos">673</span></a>    <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">clsx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]):</span>
</span><span id="gauss_params-674"><a href="#gauss_params-674"><span class="linenos">674</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="gauss_params-675"><a href="#gauss_params-675"><span class="linenos">675</span></a>            <span class="c1"># Coordinate grid</span>
</span><span id="gauss_params-676"><a href="#gauss_params-676"><span class="linenos">676</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="gauss_params-677"><a href="#gauss_params-677"><span class="linenos">677</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="gauss_params-678"><a href="#gauss_params-678"><span class="linenos">678</span></a>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="gauss_params-679"><a href="#gauss_params-679"><span class="linenos">679</span></a>            <span class="n">x_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
</span><span id="gauss_params-680"><a href="#gauss_params-680"><span class="linenos">680</span></a>
</span><span id="gauss_params-681"><a href="#gauss_params-681"><span class="linenos">681</span></a>            <span class="c1"># Initial guess</span>
</span><span id="gauss_params-682"><a href="#gauss_params-682"><span class="linenos">682</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="gauss_params-683"><a href="#gauss_params-683"><span class="linenos">683</span></a>            <span class="n">xo</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="gauss_params-684"><a href="#gauss_params-684"><span class="linenos">684</span></a>            <span class="n">yo</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="gauss_params-685"><a href="#gauss_params-685"><span class="linenos">685</span></a>            <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">sigma_y</span> <span class="o">=</span> <span class="mi">5</span>
</span><span id="gauss_params-686"><a href="#gauss_params-686"><span class="linenos">686</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="gauss_params-687"><a href="#gauss_params-687"><span class="linenos">687</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="gauss_params-688"><a href="#gauss_params-688"><span class="linenos">688</span></a>
</span><span id="gauss_params-689"><a href="#gauss_params-689"><span class="linenos">689</span></a>            <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">amplitude</span><span class="p">,</span> 
</span><span id="gauss_params-690"><a href="#gauss_params-690"><span class="linenos">690</span></a>                             <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> 
</span><span id="gauss_params-691"><a href="#gauss_params-691"><span class="linenos">691</span></a>                             <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> 
</span><span id="gauss_params-692"><a href="#gauss_params-692"><span class="linenos">692</span></a>                             <span class="n">theta</span><span class="p">,</span> 
</span><span id="gauss_params-693"><a href="#gauss_params-693"><span class="linenos">693</span></a>                             <span class="n">offset</span><span class="p">)</span>
</span><span id="gauss_params-694"><a href="#gauss_params-694"><span class="linenos">694</span></a>
</span><span id="gauss_params-695"><a href="#gauss_params-695"><span class="linenos">695</span></a>            <span class="c1"># Fit</span>
</span><span id="gauss_params-696"><a href="#gauss_params-696"><span class="linenos">696</span></a>            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gauss2D</span><span class="p">,</span> 
</span><span id="gauss_params-697"><a href="#gauss_params-697"><span class="linenos">697</span></a>                                <span class="n">x_data</span><span class="p">,</span> 
</span><span id="gauss_params-698"><a href="#gauss_params-698"><span class="linenos">698</span></a>                                <span class="n">image</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> 
</span><span id="gauss_params-699"><a href="#gauss_params-699"><span class="linenos">699</span></a>                                <span class="n">p0</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">,</span> 
</span><span id="gauss_params-700"><a href="#gauss_params-700"><span class="linenos">700</span></a>                                <span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</span><span id="gauss_params-701"><a href="#gauss_params-701"><span class="linenos">701</span></a>            
</span><span id="gauss_params-702"><a href="#gauss_params-702"><span class="linenos">702</span></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">clsx</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">popt</span><span class="p">))</span>
</span><span id="gauss_params-703"><a href="#gauss_params-703"><span class="linenos">703</span></a>
</span><span id="gauss_params-704"><a href="#gauss_params-704"><span class="linenos">704</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="gauss_params-705"><a href="#gauss_params-705"><span class="linenos">705</span></a>            <span class="c1"># On failure, append NaNs</span>
</span><span id="gauss_params-706"><a href="#gauss_params-706"><span class="linenos">706</span></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">clsx</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="gauss_params-707"><a href="#gauss_params-707"><span class="linenos">707</span></a>
</span><span id="gauss_params-708"><a href="#gauss_params-708"><span class="linenos">708</span></a>    <span class="n">df_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">param_names</span><span class="p">)</span>
</span><span id="gauss_params-709"><a href="#gauss_params-709"><span class="linenos">709</span></a>    <span class="k">return</span> <span class="n">df_params</span>
</span></pre></div>


            <div class="docstring"><p>Fits a 2D Gaussian function to each image (ROI) in the given list and 
returns the estimated parameters for each fit in a DataFrame.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>image_list</strong> (list of np.ndarray):
A list of 2D NumPy arrays representing grayscale image regions (ROIs) 
where a Gaussian-like spot is expected.</li>
<li><strong>df</strong> (pandas.DataFrame):
DataFrame containing metadata for each ROI, including a 'Class' column 
that assigns a label to each image.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><p><strong>df_params</strong> (pandas.DataFrame):
A DataFrame where each row corresponds to the parameters 
of a 2D Gaussian fit for an image in <code>image_list</code>. If a fit fails, 
the row contains NaNs.</p>

<p>Columns: class (label of the ROI), amplitude (peak height of the Gauss),
         x0, y0 (center coordinates), sigma_x (std deviation in x dir.),
         sigma_y  (std deviation in y direction), theta (rotation angle 
         of the Gaussian ellipse), offset (constant background level)</p></li>
</ul>
</div>


                </section>
                <section id="gauss2D">
                            <input id="gauss2D-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gauss2D</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">xy</span>, </span><span class="param"><span class="n">amplitude</span>, </span><span class="param"><span class="n">xo</span>, </span><span class="param"><span class="n">yo</span>, </span><span class="param"><span class="n">sigma_x</span>, </span><span class="param"><span class="n">sigma_y</span>, </span><span class="param"><span class="n">theta</span>, </span><span class="param"><span class="n">offset</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="gauss2D-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#gauss2D"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="gauss2D-712"><a href="#gauss2D-712"><span class="linenos">712</span></a><span class="k">def</span> <span class="nf">gauss2D</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
</span><span id="gauss2D-713"><a href="#gauss2D-713"><span class="linenos">713</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="gauss2D-714"><a href="#gauss2D-714"><span class="linenos">714</span></a><span class="sd">    Computes a 2D Gaussian function with elliptical shape and rotation.</span>
</span><span id="gauss2D-715"><a href="#gauss2D-715"><span class="linenos">715</span></a><span class="sd">    </span>
</span><span id="gauss2D-716"><a href="#gauss2D-716"><span class="linenos">716</span></a><span class="sd">    This function is typically used for curve fitting on 2D image data, </span>
</span><span id="gauss2D-717"><a href="#gauss2D-717"><span class="linenos">717</span></a><span class="sd">    such as intensity spots or blobs.</span>
</span><span id="gauss2D-718"><a href="#gauss2D-718"><span class="linenos">718</span></a><span class="sd">    </span>
</span><span id="gauss2D-719"><a href="#gauss2D-719"><span class="linenos">719</span></a><span class="sd">    Parameters</span>
</span><span id="gauss2D-720"><a href="#gauss2D-720"><span class="linenos">720</span></a><span class="sd">    ----------</span>
</span><span id="gauss2D-721"><a href="#gauss2D-721"><span class="linenos">721</span></a><span class="sd">    xy : tuple of np.ndarray</span>
</span><span id="gauss2D-722"><a href="#gauss2D-722"><span class="linenos">722</span></a><span class="sd">        A tuple of two flattened coordinate arrays (x, y), typically created</span>
</span><span id="gauss2D-723"><a href="#gauss2D-723"><span class="linenos">723</span></a><span class="sd">        from a meshgrid and then stacked for curve fitting. Shape of each array </span>
</span><span id="gauss2D-724"><a href="#gauss2D-724"><span class="linenos">724</span></a><span class="sd">        should be (N,), where N is the number of pixels.</span>
</span><span id="gauss2D-725"><a href="#gauss2D-725"><span class="linenos">725</span></a><span class="sd">    </span>
</span><span id="gauss2D-726"><a href="#gauss2D-726"><span class="linenos">726</span></a><span class="sd">    amplitude : float</span>
</span><span id="gauss2D-727"><a href="#gauss2D-727"><span class="linenos">727</span></a><span class="sd">        Peak height of the Gaussian.</span>
</span><span id="gauss2D-728"><a href="#gauss2D-728"><span class="linenos">728</span></a><span class="sd">    </span>
</span><span id="gauss2D-729"><a href="#gauss2D-729"><span class="linenos">729</span></a><span class="sd">    xo : float</span>
</span><span id="gauss2D-730"><a href="#gauss2D-730"><span class="linenos">730</span></a><span class="sd">        X-coordinate of the Gaussian center.</span>
</span><span id="gauss2D-731"><a href="#gauss2D-731"><span class="linenos">731</span></a><span class="sd">    </span>
</span><span id="gauss2D-732"><a href="#gauss2D-732"><span class="linenos">732</span></a><span class="sd">    yo : float</span>
</span><span id="gauss2D-733"><a href="#gauss2D-733"><span class="linenos">733</span></a><span class="sd">        Y-coordinate of the Gaussian center.</span>
</span><span id="gauss2D-734"><a href="#gauss2D-734"><span class="linenos">734</span></a><span class="sd">    </span>
</span><span id="gauss2D-735"><a href="#gauss2D-735"><span class="linenos">735</span></a><span class="sd">    sigma_x : float</span>
</span><span id="gauss2D-736"><a href="#gauss2D-736"><span class="linenos">736</span></a><span class="sd">        Standard deviation in the x-direction.</span>
</span><span id="gauss2D-737"><a href="#gauss2D-737"><span class="linenos">737</span></a><span class="sd">    </span>
</span><span id="gauss2D-738"><a href="#gauss2D-738"><span class="linenos">738</span></a><span class="sd">    sigma_y : float</span>
</span><span id="gauss2D-739"><a href="#gauss2D-739"><span class="linenos">739</span></a><span class="sd">        Standard deviation in the y-direction.</span>
</span><span id="gauss2D-740"><a href="#gauss2D-740"><span class="linenos">740</span></a><span class="sd">    </span>
</span><span id="gauss2D-741"><a href="#gauss2D-741"><span class="linenos">741</span></a><span class="sd">    theta : float</span>
</span><span id="gauss2D-742"><a href="#gauss2D-742"><span class="linenos">742</span></a><span class="sd">        Rotation angle of the Gaussian (in radians), counterclockwise.</span>
</span><span id="gauss2D-743"><a href="#gauss2D-743"><span class="linenos">743</span></a><span class="sd">    </span>
</span><span id="gauss2D-744"><a href="#gauss2D-744"><span class="linenos">744</span></a><span class="sd">    offset : float</span>
</span><span id="gauss2D-745"><a href="#gauss2D-745"><span class="linenos">745</span></a><span class="sd">        Constant offset or background intensity.</span>
</span><span id="gauss2D-746"><a href="#gauss2D-746"><span class="linenos">746</span></a><span class="sd">    </span>
</span><span id="gauss2D-747"><a href="#gauss2D-747"><span class="linenos">747</span></a><span class="sd">    Returns</span>
</span><span id="gauss2D-748"><a href="#gauss2D-748"><span class="linenos">748</span></a><span class="sd">    -------</span>
</span><span id="gauss2D-749"><a href="#gauss2D-749"><span class="linenos">749</span></a><span class="sd">    g : np.ndarray</span>
</span><span id="gauss2D-750"><a href="#gauss2D-750"><span class="linenos">750</span></a><span class="sd">        The 2D Gaussian function values evaluated at the (x, y) coordinates,</span>
</span><span id="gauss2D-751"><a href="#gauss2D-751"><span class="linenos">751</span></a><span class="sd">        returned as a 1D array (raveled). This is required by fitting functions</span>
</span><span id="gauss2D-752"><a href="#gauss2D-752"><span class="linenos">752</span></a><span class="sd">        like `scipy.optimize.curve_fit`.</span>
</span><span id="gauss2D-753"><a href="#gauss2D-753"><span class="linenos">753</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="gauss2D-754"><a href="#gauss2D-754"><span class="linenos">754</span></a>    <span class="c1"># Unpack flattened coordinate arrays</span>
</span><span id="gauss2D-755"><a href="#gauss2D-755"><span class="linenos">755</span></a>    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xy</span>
</span><span id="gauss2D-756"><a href="#gauss2D-756"><span class="linenos">756</span></a>    <span class="n">xo</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
</span><span id="gauss2D-757"><a href="#gauss2D-757"><span class="linenos">757</span></a>    <span class="n">yo</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">yo</span><span class="p">)</span>
</span><span id="gauss2D-758"><a href="#gauss2D-758"><span class="linenos">758</span></a>    
</span><span id="gauss2D-759"><a href="#gauss2D-759"><span class="linenos">759</span></a>    <span class="c1"># Pre-compute constants for rotated Gaussian</span>
</span><span id="gauss2D-760"><a href="#gauss2D-760"><span class="linenos">760</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="gauss2D-761"><a href="#gauss2D-761"><span class="linenos">761</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="gauss2D-762"><a href="#gauss2D-762"><span class="linenos">762</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="gauss2D-763"><a href="#gauss2D-763"><span class="linenos">763</span></a>    
</span><span id="gauss2D-764"><a href="#gauss2D-764"><span class="linenos">764</span></a>    <span class="c1"># Compute 2D Gaussian function values</span>
</span><span id="gauss2D-765"><a href="#gauss2D-765"><span class="linenos">765</span></a>    <span class="n">g</span> <span class="o">=</span> <span class="n">offset</span><span class="o">+</span><span class="n">amplitude</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">xo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xo</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">yo</span><span class="p">)</span><span class="o">+</span><span class="n">c</span><span class="o">*</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">yo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
</span><span id="gauss2D-766"><a href="#gauss2D-766"><span class="linenos">766</span></a>    
</span><span id="gauss2D-767"><a href="#gauss2D-767"><span class="linenos">767</span></a>   
</span><span id="gauss2D-768"><a href="#gauss2D-768"><span class="linenos">768</span></a>    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>  <span class="c1"># Flatten for compatibility with curve_fit</span>
</span></pre></div>


            <div class="docstring"><p>Computes a 2D Gaussian function with elliptical shape and rotation.</p>

<p>This function is typically used for curve fitting on 2D image data, 
such as intensity spots or blobs.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>xy</strong> (tuple of np.ndarray):
A tuple of two flattened coordinate arrays (x, y), typically created
from a meshgrid and then stacked for curve fitting. Shape of each array 
should be (N,), where N is the number of pixels.</li>
<li><strong>amplitude</strong> (float):
Peak height of the Gaussian.</li>
<li><strong>xo</strong> (float):
X-coordinate of the Gaussian center.</li>
<li><strong>yo</strong> (float):
Y-coordinate of the Gaussian center.</li>
<li><strong>sigma_x</strong> (float):
Standard deviation in the x-direction.</li>
<li><strong>sigma_y</strong> (float):
Standard deviation in the y-direction.</li>
<li><strong>theta</strong> (float):
Rotation angle of the Gaussian (in radians), counterclockwise.</li>
<li><strong>offset</strong> (float):
Constant offset or background intensity.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>g</strong> (np.ndarray):
The 2D Gaussian function values evaluated at the (x, y) coordinates,
returned as a 1D array (raveled). This is required by fitting functions
like <code>scipy.optimize.curve_fit</code>.</li>
</ul>
</div>


                </section>
                <section id="visualize_features">
                            <input id="visualize_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">method</span><span class="o">=</span><span class="s1">&#39;box&#39;</span>, </span><span class="param"><span class="n">class_col</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="visualize_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#visualize_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="visualize_features-771"><a href="#visualize_features-771"><span class="linenos">771</span></a><span class="k">def</span> <span class="nf">visualize_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">class_col</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="visualize_features-772"><a href="#visualize_features-772"><span class="linenos">772</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="visualize_features-773"><a href="#visualize_features-773"><span class="linenos">773</span></a><span class="sd">    Visualize features in the dataframe using various methods.</span>
</span><span id="visualize_features-774"><a href="#visualize_features-774"><span class="linenos">774</span></a>
</span><span id="visualize_features-775"><a href="#visualize_features-775"><span class="linenos">775</span></a><span class="sd">    Parameters:</span>
</span><span id="visualize_features-776"><a href="#visualize_features-776"><span class="linenos">776</span></a><span class="sd">    ----------</span>
</span><span id="visualize_features-777"><a href="#visualize_features-777"><span class="linenos">777</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="visualize_features-778"><a href="#visualize_features-778"><span class="linenos">778</span></a><span class="sd">        DataFrame containing feature columns and a class label column.</span>
</span><span id="visualize_features-779"><a href="#visualize_features-779"><span class="linenos">779</span></a><span class="sd">    method : str, optional (default=&quot;box&quot;)</span>
</span><span id="visualize_features-780"><a href="#visualize_features-780"><span class="linenos">780</span></a><span class="sd">        Visualization method to use. Options are:</span>
</span><span id="visualize_features-781"><a href="#visualize_features-781"><span class="linenos">781</span></a><span class="sd">            - &quot;box&quot; : Individual box plots for each feature grouped by class.</span>
</span><span id="visualize_features-782"><a href="#visualize_features-782"><span class="linenos">782</span></a><span class="sd">            - &quot;pair&quot;: Pairwise scatter plots between features, color-coded </span>
</span><span id="visualize_features-783"><a href="#visualize_features-783"><span class="linenos">783</span></a><span class="sd">                      by class.</span>
</span><span id="visualize_features-784"><a href="#visualize_features-784"><span class="linenos">784</span></a><span class="sd">            - &quot;heat&quot;: Heatmap of feature correlations.</span>
</span><span id="visualize_features-785"><a href="#visualize_features-785"><span class="linenos">785</span></a><span class="sd">    show : bool, optional (default=True)</span>
</span><span id="visualize_features-786"><a href="#visualize_features-786"><span class="linenos">786</span></a><span class="sd">        If method is &quot;box&quot;, show individual box plots for each feature.</span>
</span><span id="visualize_features-787"><a href="#visualize_features-787"><span class="linenos">787</span></a><span class="sd">    class_col : str or None, optional (default=None)</span>
</span><span id="visualize_features-788"><a href="#visualize_features-788"><span class="linenos">788</span></a><span class="sd">        Name of the class label column. If None, the function tries to infer </span>
</span><span id="visualize_features-789"><a href="#visualize_features-789"><span class="linenos">789</span></a><span class="sd">        the class column by looking for a column with &lt;10 unique values and </span>
</span><span id="visualize_features-790"><a href="#visualize_features-790"><span class="linenos">790</span></a><span class="sd">        categorical/object/integer dtype.</span>
</span><span id="visualize_features-791"><a href="#visualize_features-791"><span class="linenos">791</span></a>
</span><span id="visualize_features-792"><a href="#visualize_features-792"><span class="linenos">792</span></a><span class="sd">    Returns:</span>
</span><span id="visualize_features-793"><a href="#visualize_features-793"><span class="linenos">793</span></a><span class="sd">    -------</span>
</span><span id="visualize_features-794"><a href="#visualize_features-794"><span class="linenos">794</span></a><span class="sd">    df : pandas.DataFrame</span>
</span><span id="visualize_features-795"><a href="#visualize_features-795"><span class="linenos">795</span></a><span class="sd">        The original dataframe passed in, unchanged.</span>
</span><span id="visualize_features-796"><a href="#visualize_features-796"><span class="linenos">796</span></a><span class="sd">    </span>
</span><span id="visualize_features-797"><a href="#visualize_features-797"><span class="linenos">797</span></a><span class="sd">    Raises:</span>
</span><span id="visualize_features-798"><a href="#visualize_features-798"><span class="linenos">798</span></a><span class="sd">    ------</span>
</span><span id="visualize_features-799"><a href="#visualize_features-799"><span class="linenos">799</span></a><span class="sd">    ValueError</span>
</span><span id="visualize_features-800"><a href="#visualize_features-800"><span class="linenos">800</span></a><span class="sd">        If class_col cannot be inferred or if method is invalid or insufficient </span>
</span><span id="visualize_features-801"><a href="#visualize_features-801"><span class="linenos">801</span></a><span class="sd">        features are present for plotting.</span>
</span><span id="visualize_features-802"><a href="#visualize_features-802"><span class="linenos">802</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="visualize_features-803"><a href="#visualize_features-803"><span class="linenos">803</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span>
</span><span id="visualize_features-804"><a href="#visualize_features-804"><span class="linenos">804</span></a>
</span><span id="visualize_features-805"><a href="#visualize_features-805"><span class="linenos">805</span></a>    <span class="c1"># Try to infer class column if not provided</span>
</span><span id="visualize_features-806"><a href="#visualize_features-806"><span class="linenos">806</span></a>    <span class="k">if</span> <span class="n">class_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="visualize_features-807"><a href="#visualize_features-807"><span class="linenos">807</span></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="visualize_features-808"><a href="#visualize_features-808"><span class="linenos">808</span></a>            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="visualize_features-809"><a href="#visualize_features-809"><span class="linenos">809</span></a>                    <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">]:</span>
</span><span id="visualize_features-810"><a href="#visualize_features-810"><span class="linenos">810</span></a>                <span class="n">class_col</span> <span class="o">=</span> <span class="n">col</span>
</span><span id="visualize_features-811"><a href="#visualize_features-811"><span class="linenos">811</span></a>                <span class="k">break</span>
</span><span id="visualize_features-812"><a href="#visualize_features-812"><span class="linenos">812</span></a>        <span class="k">if</span> <span class="n">class_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="visualize_features-813"><a href="#visualize_features-813"><span class="linenos">813</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="visualize_features-814"><a href="#visualize_features-814"><span class="linenos">814</span></a>                <span class="s2">&quot;Could not determine class column. Please specify &#39;class_col&#39;.&quot;</span><span class="p">)</span>
</span><span id="visualize_features-815"><a href="#visualize_features-815"><span class="linenos">815</span></a>
</span><span id="visualize_features-816"><a href="#visualize_features-816"><span class="linenos">816</span></a>    <span class="c1"># Filter numeric feature columns</span>
</span><span id="visualize_features-817"><a href="#visualize_features-817"><span class="linenos">817</span></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>\
</span><span id="visualize_features-818"><a href="#visualize_features-818"><span class="linenos">818</span></a>                    <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">class_col</span><span class="p">]</span>
</span><span id="visualize_features-819"><a href="#visualize_features-819"><span class="linenos">819</span></a>
</span><span id="visualize_features-820"><a href="#visualize_features-820"><span class="linenos">820</span></a>    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;box&quot;</span><span class="p">:</span>
</span><span id="visualize_features-821"><a href="#visualize_features-821"><span class="linenos">821</span></a>        <span class="c1"># Box plot interpretation:</span>
</span><span id="visualize_features-822"><a href="#visualize_features-822"><span class="linenos">822</span></a>        <span class="c1"># - Box height (IQR): Spread of values</span>
</span><span id="visualize_features-823"><a href="#visualize_features-823"><span class="linenos">823</span></a>        <span class="c1"># - Median: Line inside the box</span>
</span><span id="visualize_features-824"><a href="#visualize_features-824"><span class="linenos">824</span></a>        <span class="c1"># - Whiskers: Range (excluding outliers)</span>
</span><span id="visualize_features-825"><a href="#visualize_features-825"><span class="linenos">825</span></a>        <span class="c1"># - Outliers: Individual points</span>
</span><span id="visualize_features-826"><a href="#visualize_features-826"><span class="linenos">826</span></a>        <span class="c1"># Use case:</span>
</span><span id="visualize_features-827"><a href="#visualize_features-827"><span class="linenos">827</span></a>        <span class="c1"># - Feature distributions across classes</span>
</span><span id="visualize_features-828"><a href="#visualize_features-828"><span class="linenos">828</span></a>        <span class="c1"># - Identify separable features</span>
</span><span id="visualize_features-829"><a href="#visualize_features-829"><span class="linenos">829</span></a>        
</span><span id="visualize_features-830"><a href="#visualize_features-830"><span class="linenos">830</span></a>      <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
</span><span id="visualize_features-831"><a href="#visualize_features-831"><span class="linenos">831</span></a>          <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="visualize_features-832"><a href="#visualize_features-832"><span class="linenos">832</span></a>              <span class="c1"># Remove outliers based on IQR</span>
</span><span id="visualize_features-833"><a href="#visualize_features-833"><span class="linenos">833</span></a>              <span class="n">Q1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="visualize_features-834"><a href="#visualize_features-834"><span class="linenos">834</span></a>              <span class="n">Q3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</span><span id="visualize_features-835"><a href="#visualize_features-835"><span class="linenos">835</span></a>              <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
</span><span id="visualize_features-836"><a href="#visualize_features-836"><span class="linenos">836</span></a>              <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="visualize_features-837"><a href="#visualize_features-837"><span class="linenos">837</span></a>              <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="visualize_features-838"><a href="#visualize_features-838"><span class="linenos">838</span></a>  
</span><span id="visualize_features-839"><a href="#visualize_features-839"><span class="linenos">839</span></a>              <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">lower_bound</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">upper_bound</span><span class="p">)]</span>
</span><span id="visualize_features-840"><a href="#visualize_features-840"><span class="linenos">840</span></a>  
</span><span id="visualize_features-841"><a href="#visualize_features-841"><span class="linenos">841</span></a>              <span class="c1"># Plot</span>
</span><span id="visualize_features-842"><a href="#visualize_features-842"><span class="linenos">842</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</span><span id="visualize_features-843"><a href="#visualize_features-843"><span class="linenos">843</span></a>              <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">class_col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">class_col</span><span class="p">,</span> 
</span><span id="visualize_features-844"><a href="#visualize_features-844"><span class="linenos">844</span></a>                          <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="visualize_features-845"><a href="#visualize_features-845"><span class="linenos">845</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution of </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1"> across classes (no outliers)&#39;</span><span class="p">)</span>
</span><span id="visualize_features-846"><a href="#visualize_features-846"><span class="linenos">846</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">class_col</span><span class="p">)</span>
</span><span id="visualize_features-847"><a href="#visualize_features-847"><span class="linenos">847</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
</span><span id="visualize_features-848"><a href="#visualize_features-848"><span class="linenos">848</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="visualize_features-849"><a href="#visualize_features-849"><span class="linenos">849</span></a>              <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="visualize_features-850"><a href="#visualize_features-850"><span class="linenos">850</span></a>          <span class="k">else</span><span class="p">:</span>
</span><span id="visualize_features-851"><a href="#visualize_features-851"><span class="linenos">851</span></a>              <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2"> - contains inf/NaN.&quot;</span><span class="p">)</span>
</span><span id="visualize_features-852"><a href="#visualize_features-852"><span class="linenos">852</span></a>
</span><span id="visualize_features-853"><a href="#visualize_features-853"><span class="linenos">853</span></a>
</span><span id="visualize_features-854"><a href="#visualize_features-854"><span class="linenos">854</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
</span><span id="visualize_features-855"><a href="#visualize_features-855"><span class="linenos">855</span></a>        <span class="c1"># Pair plot interpretation:</span>
</span><span id="visualize_features-856"><a href="#visualize_features-856"><span class="linenos">856</span></a>        <span class="c1"># - Each scatter plot shows how two features interact, color-coded b</span>
</span><span id="visualize_features-857"><a href="#visualize_features-857"><span class="linenos">857</span></a>        <span class="c1">#   y class</span>
</span><span id="visualize_features-858"><a href="#visualize_features-858"><span class="linenos">858</span></a>        <span class="c1"># - Diagonal shows feature distributions (histograms or KDEs)</span>
</span><span id="visualize_features-859"><a href="#visualize_features-859"><span class="linenos">859</span></a>        <span class="c1"># Use case:</span>
</span><span id="visualize_features-860"><a href="#visualize_features-860"><span class="linenos">860</span></a>        <span class="c1"># - Identify feature combinations that separate classes</span>
</span><span id="visualize_features-861"><a href="#visualize_features-861"><span class="linenos">861</span></a>        <span class="c1"># - Spot clusters or trends</span>
</span><span id="visualize_features-862"><a href="#visualize_features-862"><span class="linenos">862</span></a>
</span><span id="visualize_features-863"><a href="#visualize_features-863"><span class="linenos">863</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="visualize_features-864"><a href="#visualize_features-864"><span class="linenos">864</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="visualize_features-865"><a href="#visualize_features-865"><span class="linenos">865</span></a>                <span class="s2">&quot;Need at least two numeric features to create a pairplot.&quot;</span><span class="p">)</span>
</span><span id="visualize_features-866"><a href="#visualize_features-866"><span class="linenos">866</span></a>
</span><span id="visualize_features-867"><a href="#visualize_features-867"><span class="linenos">867</span></a>        <span class="c1"># Remove outliers across all selected features using IQR</span>
</span><span id="visualize_features-868"><a href="#visualize_features-868"><span class="linenos">868</span></a>        <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="visualize_features-869"><a href="#visualize_features-869"><span class="linenos">869</span></a>        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
</span><span id="visualize_features-870"><a href="#visualize_features-870"><span class="linenos">870</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="visualize_features-871"><a href="#visualize_features-871"><span class="linenos">871</span></a>              <span class="c1"># Remove outliers based on IQR</span>
</span><span id="visualize_features-872"><a href="#visualize_features-872"><span class="linenos">872</span></a>              <span class="n">Q1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="visualize_features-873"><a href="#visualize_features-873"><span class="linenos">873</span></a>              <span class="n">Q3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</span><span id="visualize_features-874"><a href="#visualize_features-874"><span class="linenos">874</span></a>              <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
</span><span id="visualize_features-875"><a href="#visualize_features-875"><span class="linenos">875</span></a>              <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="visualize_features-876"><a href="#visualize_features-876"><span class="linenos">876</span></a>              <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="visualize_features-877"><a href="#visualize_features-877"><span class="linenos">877</span></a>  
</span><span id="visualize_features-878"><a href="#visualize_features-878"><span class="linenos">878</span></a>              <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">lower_bound</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">upper_bound</span><span class="p">)]</span>
</span><span id="visualize_features-879"><a href="#visualize_features-879"><span class="linenos">879</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="visualize_features-880"><a href="#visualize_features-880"><span class="linenos">880</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping outlier removal for </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2"> (contains inf/NaN)&quot;</span><span class="p">)</span>
</span><span id="visualize_features-881"><a href="#visualize_features-881"><span class="linenos">881</span></a>    
</span><span id="visualize_features-882"><a href="#visualize_features-882"><span class="linenos">882</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">[</span><span class="n">feature_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">class_col</span><span class="p">]],</span> 
</span><span id="visualize_features-883"><a href="#visualize_features-883"><span class="linenos">883</span></a>                     <span class="n">hue</span><span class="o">=</span><span class="n">class_col</span><span class="p">,</span> 
</span><span id="visualize_features-884"><a href="#visualize_features-884"><span class="linenos">884</span></a>                     <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">)</span>
</span><span id="visualize_features-885"><a href="#visualize_features-885"><span class="linenos">885</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Feature pairwise relationships by class (no outliers)&quot;</span><span class="p">,</span> 
</span><span id="visualize_features-886"><a href="#visualize_features-886"><span class="linenos">886</span></a>                     <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
</span><span id="visualize_features-887"><a href="#visualize_features-887"><span class="linenos">887</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="visualize_features-888"><a href="#visualize_features-888"><span class="linenos">888</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="visualize_features-889"><a href="#visualize_features-889"><span class="linenos">889</span></a>
</span><span id="visualize_features-890"><a href="#visualize_features-890"><span class="linenos">890</span></a>
</span><span id="visualize_features-891"><a href="#visualize_features-891"><span class="linenos">891</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;heat&quot;</span><span class="p">:</span>
</span><span id="visualize_features-892"><a href="#visualize_features-892"><span class="linenos">892</span></a>        <span class="c1"># Heatmap interpretation:</span>
</span><span id="visualize_features-893"><a href="#visualize_features-893"><span class="linenos">893</span></a>        <span class="c1"># - Shows correlation between all pairs of numeric features</span>
</span><span id="visualize_features-894"><a href="#visualize_features-894"><span class="linenos">894</span></a>        <span class="c1"># - +1: Perfect positive correlation</span>
</span><span id="visualize_features-895"><a href="#visualize_features-895"><span class="linenos">895</span></a>        <span class="c1"># -  0: No correlation</span>
</span><span id="visualize_features-896"><a href="#visualize_features-896"><span class="linenos">896</span></a>        <span class="c1"># - -1: Perfect negative correlation</span>
</span><span id="visualize_features-897"><a href="#visualize_features-897"><span class="linenos">897</span></a>        <span class="c1"># Use case:</span>
</span><span id="visualize_features-898"><a href="#visualize_features-898"><span class="linenos">898</span></a>        <span class="c1"># - Detect redundant features (e.g., corr &gt; 0.8)</span>
</span><span id="visualize_features-899"><a href="#visualize_features-899"><span class="linenos">899</span></a>        <span class="c1"># - Feature reduction or PCA</span>
</span><span id="visualize_features-900"><a href="#visualize_features-900"><span class="linenos">900</span></a>        <span class="c1"># - Clustered heatmap can reveal groups of related features</span>
</span><span id="visualize_features-901"><a href="#visualize_features-901"><span class="linenos">901</span></a>
</span><span id="visualize_features-902"><a href="#visualize_features-902"><span class="linenos">902</span></a>        <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
</span><span id="visualize_features-903"><a href="#visualize_features-903"><span class="linenos">903</span></a>        <span class="k">if</span> <span class="n">class_col</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
</span><span id="visualize_features-904"><a href="#visualize_features-904"><span class="linenos">904</span></a>            <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">feature_cols</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">class_col</span><span class="p">)</span>
</span><span id="visualize_features-905"><a href="#visualize_features-905"><span class="linenos">905</span></a>        
</span><span id="visualize_features-906"><a href="#visualize_features-906"><span class="linenos">906</span></a>        <span class="c1"># Remove outliers from all numeric features using IQR</span>
</span><span id="visualize_features-907"><a href="#visualize_features-907"><span class="linenos">907</span></a>        <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="visualize_features-908"><a href="#visualize_features-908"><span class="linenos">908</span></a>        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feature_cols</span><span class="p">:</span>
</span><span id="visualize_features-909"><a href="#visualize_features-909"><span class="linenos">909</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="visualize_features-910"><a href="#visualize_features-910"><span class="linenos">910</span></a>                <span class="n">Q1</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="visualize_features-911"><a href="#visualize_features-911"><span class="linenos">911</span></a>                <span class="n">Q3</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</span><span id="visualize_features-912"><a href="#visualize_features-912"><span class="linenos">912</span></a>                <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
</span><span id="visualize_features-913"><a href="#visualize_features-913"><span class="linenos">913</span></a>                <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="visualize_features-914"><a href="#visualize_features-914"><span class="linenos">914</span></a>                <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">IQR</span>
</span><span id="visualize_features-915"><a href="#visualize_features-915"><span class="linenos">915</span></a>                <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[(</span><span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">&amp;</span> 
</span><span id="visualize_features-916"><a href="#visualize_features-916"><span class="linenos">916</span></a>                                          <span class="p">(</span><span class="n">df_filtered</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper_bound</span><span class="p">)]</span>
</span><span id="visualize_features-917"><a href="#visualize_features-917"><span class="linenos">917</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="visualize_features-918"><a href="#visualize_features-918"><span class="linenos">918</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping outlier removal for </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2"> (contains inf/NaN)&quot;</span><span class="p">)</span>
</span><span id="visualize_features-919"><a href="#visualize_features-919"><span class="linenos">919</span></a>            
</span><span id="visualize_features-920"><a href="#visualize_features-920"><span class="linenos">920</span></a>        <span class="n">corr</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</span><span id="visualize_features-921"><a href="#visualize_features-921"><span class="linenos">921</span></a>
</span><span id="visualize_features-922"><a href="#visualize_features-922"><span class="linenos">922</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)),</span> 
</span><span id="visualize_features-923"><a href="#visualize_features-923"><span class="linenos">923</span></a>                            <span class="nb">max</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">))))</span>
</span><span id="visualize_features-924"><a href="#visualize_features-924"><span class="linenos">924</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> 
</span><span id="visualize_features-925"><a href="#visualize_features-925"><span class="linenos">925</span></a>                    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> 
</span><span id="visualize_features-926"><a href="#visualize_features-926"><span class="linenos">926</span></a>                    <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span><span id="visualize_features-927"><a href="#visualize_features-927"><span class="linenos">927</span></a>                    <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> 
</span><span id="visualize_features-928"><a href="#visualize_features-928"><span class="linenos">928</span></a>                    <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span><span id="visualize_features-929"><a href="#visualize_features-929"><span class="linenos">929</span></a>                    <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">.8</span><span class="p">})</span>
</span><span id="visualize_features-930"><a href="#visualize_features-930"><span class="linenos">930</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Feature Correlation Heatmap&quot;</span><span class="p">)</span>
</span><span id="visualize_features-931"><a href="#visualize_features-931"><span class="linenos">931</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="visualize_features-932"><a href="#visualize_features-932"><span class="linenos">932</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="visualize_features-933"><a href="#visualize_features-933"><span class="linenos">933</span></a>
</span><span id="visualize_features-934"><a href="#visualize_features-934"><span class="linenos">934</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="visualize_features-935"><a href="#visualize_features-935"><span class="linenos">935</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported method. Use &#39;box&#39;, &#39;pair&#39;, or &#39;heat&#39;.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize features in the dataframe using various methods.</p>

<h2 id="parameters">Parameters:</h2>

<p>df : pandas.DataFrame
    DataFrame containing feature columns and a class label column.
method : str, optional (default="box")
    Visualization method to use. Options are:
        - "box" : Individual box plots for each feature grouped by class.
        - "pair": Pairwise scatter plots between features, color-coded 
                  by class.
        - "heat": Heatmap of feature correlations.
show : bool, optional (default=True)
    If method is "box", show individual box plots for each feature.
class_col : str or None, optional (default=None)
    Name of the class label column. If None, the function tries to infer 
    the class column by looking for a column with &lt;10 unique values and 
    categorical/object/integer dtype.</p>

<h2 id="returns">Returns:</h2>

<p>df : pandas.DataFrame
    The original dataframe passed in, unchanged.</p>

<h2 id="raises">Raises:</h2>

<p>ValueError
    If class_col cannot be inferred or if method is invalid or insufficient 
    features are present for plotting.</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>